<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BRObet - NFL Predictions</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            min-height: 100vh;
            padding: 1rem;
            color: white;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            margin-bottom: 2rem;
        }

        h1 {
            font-size: clamp(2rem, 5vw, 3.5rem);
            margin-bottom: 0.5rem;
            color: #3498db;
            font-weight: 900;
        }

        .tagline {
            color: #95a5a6;
            font-size: clamp(0.9rem, 2vw, 1.1rem);
            font-weight: 500;
        }

        .week-indicator {
            font-size: clamp(1rem, 3vw, 1.5rem);
            color: #3498db;
            font-weight: bold;
            margin: 0.5rem 0;
        }

        .api-setup {
            background: rgba(52, 152, 219, 0.1);
            border: 2px solid rgba(52, 152, 219, 0.3);
            border-radius: 1rem;
            padding: 2rem;
            margin-bottom: 2rem;
            text-align: center;
        }

        .api-setup h3 {
            margin-bottom: 1rem;
            color: #3498db;
        }

        .api-setup input {
            width: 100%;
            max-width: 400px;
            padding: 0.75rem;
            margin: 1rem 0;
            border-radius: 0.5rem;
            border: 2px solid rgba(52, 152, 219, 0.3);
            background: rgba(255, 255, 255, 0.05);
            color: white;
            font-size: 1rem;
        }

        .api-setup button {
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
            color: white;
            border: none;
            padding: 0.75rem 2rem;
            border-radius: 0.5rem;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .api-setup button:hover {
            transform: scale(1.05);
        }

        .scoreboard {
            background: rgba(52, 152, 219, 0.1);
            border-radius: 1rem;
            padding: 1.5rem;
            margin-bottom: 2rem;
            border: 2px solid rgba(52, 152, 219, 0.3);
        }

        .scoreboard-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1.5rem;
        }

        .stats {
            display: flex;
            gap: 2rem;
        }

        .stat {
            text-align: center;
        }

        .stat-value {
            font-size: 2.5rem;
            font-weight: bold;
            color: #3498db;
        }

        .stat-label {
            color: #95a5a6;
            margin-top: 0.25rem;
            font-size: 0.9rem;
        }

        .loading {
            text-align: center;
            padding: 3rem;
            font-size: 1.2rem;
            color: #3498db;
        }

        .error {
            background: rgba(231, 76, 60, 0.2);
            border: 2px solid rgba(231, 76, 60, 0.5);
            color: #e74c3c;
            padding: 1rem;
            border-radius: 0.5rem;
            margin-bottom: 1rem;
        }

        .games-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(min(100%, 500px), 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .game-card {
            border-radius: 1rem;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            transition: transform 0.2s;
        }

        .game-card:hover {
            transform: translateY(-5px);
        }

        .game-header {
            padding: 1.5rem;
            color: white;
        }

        .game-meta {
            display: flex;
            gap: 0.75rem;
            margin-bottom: 1rem;
            flex-wrap: wrap;
        }

        .badge {
            background: rgba(255, 255, 255, 0.2);
            padding: 0.35rem 0.75rem;
            border-radius: 1rem;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .confidence-high {
            background: linear-gradient(135deg, #27ae60 0%, #229954 100%);
        }

        .confidence-medium {
            background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
        }

        .confidence-low {
            background: linear-gradient(135deg, #95a5a6 0%, #7f8c8d 100%);
        }

        .fallback-badge {
            background: linear-gradient(135deg, #e67e22 0%, #d35400 100%);
        }

        .teams {
            display: flex;
            justify-content: space-around;
            align-items: center;
            gap: 1rem;
        }

        .team {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .team-logo {
            width: 50px;
            height: 50px;
            object-fit: contain;
        }

        .team-name {
            font-size: 1.1rem;
            font-weight: bold;
        }

        .team-record {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .vs {
            font-size: 1.5rem;
            font-weight: bold;
            opacity: 0.5;
        }

        .game-body {
            background: rgba(0, 0, 0, 0.4);
            padding: 1.5rem;
        }

        .winner-section {
            text-align: center;
            margin-bottom: 1.5rem;
        }

        .winner-label {
            font-size: 0.9rem;
            color: #3498db;
            margin-bottom: 0.5rem;
        }

        .winner-name {
            font-size: 1.8rem;
            font-weight: bold;
            margin-bottom: 0.5rem;
        }

        .confidence {
            font-size: 0.9rem;
            opacity: 0.8;
        }

        .rationale {
            margin-top: 1rem;
            background: rgba(255, 255, 255, 0.05);
            padding: 1rem;
            border-radius: 0.5rem;
            text-align: left;
        }

        .rationale-item {
            padding: 0.35rem 0;
            font-size: 0.9rem;
            line-height: 1.4;
        }

        .prediction-section {
            margin-top: 1.5rem;
        }

        .prediction-title {
            font-weight: bold;
            margin-bottom: 0.75rem;
            color: #3498db;
        }

        .prediction-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
        }

        .pred-stat {
            background: rgba(255, 255, 255, 0.05);
            padding: 1rem;
            border-radius: 0.5rem;
            text-align: center;
        }

        .pred-label {
            font-size: 0.9rem;
            opacity: 0.8;
            margin-bottom: 0.5rem;
        }

        .pred-value {
            font-size: 2rem;
            font-weight: bold;
            color: #3498db;
        }

        .stats-breakdown {
            background: rgba(255, 255, 255, 0.05);
            padding: 1rem;
            border-radius: 0.5rem;
        }

        .stat-row {
            display: flex;
            justify-content: space-between;
            padding: 0.5rem 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .stat-row:last-child {
            border-bottom: none;
        }

        .matchup-edge {
            background: rgba(52, 152, 219, 0.2);
            padding: 0.75rem;
            border-radius: 0.5rem;
            margin-bottom: 0.5rem;
            border-left: 3px solid #3498db;
        }

        .edge-item {
            font-size: 0.9rem;
        }

        .injuries {
            margin-top: 0.75rem;
        }

        .injury-item {
            font-size: 0.85rem;
            padding: 0.25rem 0;
            opacity: 0.9;
        }

        .injury-item a {
            color: #3498db;
            text-decoration: none;
        }

        .injury-item a:hover {
            text-decoration: underline;
        }

        .footer {
            text-align: center;
            padding: 2rem 1rem;
            margin-top: 3rem;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            color: #95a5a6;
            font-size: 0.85rem;
            line-height: 1.6;
        }

        .disclaimer {
            max-width: 800px;
            margin: 1rem auto 0;
            font-size: 0.75rem;
            opacity: 0.7;
        }

        @media (max-width: 768px) {
            .teams {
                flex-direction: column;
            }

            .stats {
                gap: 1rem;
            }

            .stat-value {
                font-size: 2rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üèà BRObet</h1>
            <p class="tagline">Advanced NFL Predictions & Matchup Analysis</p>
            <div class="week-indicator" id="weekIndicator">Loading...</div>
        </header>

        <div class="api-setup" id="apiSetup">
            <h3>üîë The Odds API Key Required</h3>
            <p style="color: #95a5a6;">
                Get your free API key from <a href="https://the-odds-api.com/" target="_blank" style="color: #3498db;">the-odds-api.com</a>
            </p>
            <input type="text" id="apiKeyInput" placeholder="Enter your API key here" />
            <button onclick="saveApiKey()">Save & Load Predictions</button>
        </div>

        <div class="scoreboard">
            <div class="scoreboard-content">
                <div>
                    <h2>üìà Prediction Accuracy</h2>
                    <p style="color: #95a5a6;">Season Performance</p>
                </div>
                <div class="stats">
                    <div class="stat">
                        <div class="stat-value" id="correct">0</div>
                        <div class="stat-label">Correct</div>
                    </div>
                    <div class="stat">
                        <div class="stat-value" id="total">0</div>
                        <div class="stat-label">Total</div>
                    </div>
                    <div class="stat">
                        <div class="stat-value" id="accuracy">0%</div>
                        <div class="stat-label">Accuracy</div>
                    </div>
                </div>
            </div>
        </div>

        <div id="error" class="error" style="display: none;"></div>
        <div id="loading" class="loading">Enter your API key to load predictions...</div>
        <div id="picksummary" class="scoreboard" style="display: none;">
            <h2 style="margin-bottom: 1rem;">üéØ Top Picks</h2>
            <div id="picks-list" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 0.75rem;"></div>
        </div>
        <div id="games" class="games-grid"></div>

        <footer class="footer">
            <div>¬© 2025 BRObet. All rights reserved.</div>
            <div class="disclaimer">
                <strong>DISCLAIMER:</strong> This website is for informational and entertainment purposes only.
                BRObet provides NFL game predictions and analysis based on statistical models and publicly available data.
                No guarantees are made regarding the accuracy of predictions. Sports betting involves risk, and you should never
                wager more than you can afford to lose. We are not responsible for any losses incurred through the use of
                information provided on this site. Users assume all risk and liability for their betting decisions.
                This site does not operate as a gambling service and does not accept wagers. Please gamble responsibly and
                consult local laws regarding sports betting in your jurisdiction. By using this site, you acknowledge and
                agree to these terms.
            </div>
        </footer>
    </div>

    <script>
        // ===== CONFIGURATION =====
        let apiKey = localStorage.getItem('nfl_odds_api_key') || '';
        let predictions = JSON.parse(localStorage.getItem('nfl_predictions') || '{}');
        let accuracyStats = JSON.parse(localStorage.getItem('nfl_accuracy') || '{"correct": 0, "total": 0}');

        // Team data (logos only - all stats fetched dynamically)
        const TEAM_DATA = {
            "Arizona Cardinals": { logo: "https://a.espncdn.com/i/teamlogos/nfl/500/ari.png", color: "#97233F", lat: 33.5276, lon: -112.2626 },
            "Atlanta Falcons": { logo: "https://a.espncdn.com/i/teamlogos/nfl/500/atl.png", color: "#A71930", lat: 33.7554, lon: -84.4008 },
            "Baltimore Ravens": { logo: "https://a.espncdn.com/i/teamlogos/nfl/500/bal.png", color: "#241773", lat: 39.2780, lon: -76.6227 },
            "Buffalo Bills": { logo: "https://a.espncdn.com/i/teamlogos/nfl/500/buf.png", color: "#00338D", lat: 42.7738, lon: -78.7870 },
            "Carolina Panthers": { logo: "https://a.espncdn.com/i/teamlogos/nfl/500/car.png", color: "#0085CA", lat: 35.2258, lon: -80.8530 },
            "Chicago Bears": { logo: "https://a.espncdn.com/i/teamlogos/nfl/500/chi.png", color: "#0B162A", lat: 41.8623, lon: -87.6167 },
            "Cincinnati Bengals": { logo: "https://a.espncdn.com/i/teamlogos/nfl/500/cin.png", color: "#FB4F14", lat: 39.0954, lon: -84.5160 },
            "Cleveland Browns": { logo: "https://a.espncdn.com/i/teamlogos/nfl/500/cle.png", color: "#311D00", lat: 41.5061, lon: -81.6995 },
            "Dallas Cowboys": { logo: "https://a.espncdn.com/i/teamlogos/nfl/500/dal.png", color: "#003594", lat: 32.7473, lon: -97.0945 },
            "Denver Broncos": { logo: "https://a.espncdn.com/i/teamlogos/nfl/500/den.png", color: "#FB4F14", lat: 39.7439, lon: -105.0201 },
            "Detroit Lions": { logo: "https://a.espncdn.com/i/teamlogos/nfl/500/det.png", color: "#0076B6", lat: 42.3400, lon: -83.0456 },
            "Green Bay Packers": { logo: "https://a.espncdn.com/i/teamlogos/nfl/500/gb.png", color: "#203731", lat: 44.5013, lon: -88.0622 },
            "Houston Texans": { logo: "https://a.espncdn.com/i/teamlogos/nfl/500/hou.png", color: "#03202F", lat: 29.6847, lon: -95.4107 },
            "Indianapolis Colts": { logo: "https://a.espncdn.com/i/teamlogos/nfl/500/ind.png", color: "#002C5F", lat: 39.7601, lon: -86.1639 },
            "Jacksonville Jaguars": { logo: "https://a.espncdn.com/i/teamlogos/nfl/500/jax.png", color: "#006778", lat: 30.3240, lon: -81.6373 },
            "Kansas City Chiefs": { logo: "https://a.espncdn.com/i/teamlogos/nfl/500/kc.png", color: "#E31837", lat: 39.0489, lon: -94.4839 },
            "Las Vegas Raiders": { logo: "https://a.espncdn.com/i/teamlogos/nfl/500/lv.png", color: "#000000", lat: 36.0908, lon: -115.1831 },
            "Los Angeles Chargers": { logo: "https://a.espncdn.com/i/teamlogos/nfl/500/lac.png", color: "#0080C6", lat: 33.9535, lon: -118.3390 },
            "Los Angeles Rams": { logo: "https://a.espncdn.com/i/teamlogos/nfl/500/lar.png", color: "#003594", lat: 33.9535, lon: -118.3390 },
            "Miami Dolphins": { logo: "https://a.espncdn.com/i/teamlogos/nfl/500/mia.png", color: "#008E97", lat: 25.9580, lon: -80.2389 },
            "Minnesota Vikings": { logo: "https://a.espncdn.com/i/teamlogos/nfl/500/min.png", color: "#4F2683", lat: 44.9738, lon: -93.2577 },
            "New England Patriots": { logo: "https://a.espncdn.com/i/teamlogos/nfl/500/ne.png", color: "#002244", lat: 42.0909, lon: -71.2643 },
            "New Orleans Saints": { logo: "https://a.espncdn.com/i/teamlogos/nfl/500/no.png", color: "#D3BC8D", lat: 29.9511, lon: -90.0812 },
            "New York Giants": { logo: "https://a.espncdn.com/i/teamlogos/nfl/500/nyg.png", color: "#0B2265", lat: 40.8128, lon: -74.0742 },
            "New York Jets": { logo: "https://a.espncdn.com/i/teamlogos/nfl/500/nyj.png", color: "#125740", lat: 40.8128, lon: -74.0742 },
            "Philadelphia Eagles": { logo: "https://a.espncdn.com/i/teamlogos/nfl/500/phi.png", color: "#004C54", lat: 39.9008, lon: -75.1675 },
            "Pittsburgh Steelers": { logo: "https://a.espncdn.com/i/teamlogos/nfl/500/pit.png", color: "#FFB612", lat: 40.4468, lon: -80.0158 },
            "San Francisco 49ers": { logo: "https://a.espncdn.com/i/teamlogos/nfl/500/sf.png", color: "#AA0000", lat: 37.4032, lon: -121.9697 },
            "Seattle Seahawks": { logo: "https://a.espncdn.com/i/teamlogos/nfl/500/sea.png", color: "#002244", lat: 47.5952, lon: -122.3316 },
            "Tampa Bay Buccaneers": { logo: "https://a.espncdn.com/i/teamlogos/nfl/500/tb.png", color: "#D50A0A", lat: 27.9759, lon: -82.5033 },
            "Tennessee Titans": { logo: "https://a.espncdn.com/i/teamlogos/nfl/500/ten.png", color: "#0C2340", lat: 36.1665, lon: -86.7713 },
            "Washington Commanders": { logo: "https://a.espncdn.com/i/teamlogos/nfl/500/wsh.png", color: "#5A1414", lat: 38.9076, lon: -76.8645 }
        };

        // 2025 NFL Week 15 Rankings (Hardcoded Fallback - Update Weekly)
        const HARDCODED_RANKINGS_2025 = {
            "Buffalo Bills": { rushOffRank: 1, passOffRank: 10, rushDefRank: 2, passDefRank: 12 },
            "Philadelphia Eagles": { rushOffRank: 2, passOffRank: 5, rushDefRank: 15, passDefRank: 3 },
            "Baltimore Ravens": { rushOffRank: 3, passOffRank: 7, rushDefRank: 19, passDefRank: 25 },
            "Chicago Bears": { rushOffRank: 4, passOffRank: 25, rushDefRank: 4, passDefRank: 10 },
            "Washington Commanders": { rushOffRank: 5, passOffRank: 12, rushDefRank: 22, passDefRank: 18 },
            "Detroit Lions": { rushOffRank: 6, passOffRank: 3, rushDefRank: 23, passDefRank: 20 },
            "Green Bay Packers": { rushOffRank: 7, passOffRank: 14, rushDefRank: 8, passDefRank: 9 },
            "Pittsburgh Steelers": { rushOffRank: 8, passOffRank: 23, rushDefRank: 1, passDefRank: 1 },
            "Tampa Bay Buccaneers": { rushOffRank: 9, passOffRank: 1, rushDefRank: 14, passDefRank: 28 },
            "Dallas Cowboys": { rushOffRank: 10, passOffRank: 2, rushDefRank: 25, passDefRank: 27 },
            "Los Angeles Chargers": { rushOffRank: 11, passOffRank: 16, rushDefRank: 6, passDefRank: 7 },
            "Minnesota Vikings": { rushOffRank: 12, passOffRank: 11, rushDefRank: 5, passDefRank: 4 },
            "San Francisco 49ers": { rushOffRank: 13, passOffRank: 9, rushDefRank: 10, passDefRank: 6 },
            "Atlanta Falcons": { rushOffRank: 14, passOffRank: 13, rushDefRank: 26, passDefRank: 24 },
            "Arizona Cardinals": { rushOffRank: 15, passOffRank: 18, rushDefRank: 11, passDefRank: 16 },
            "Denver Broncos": { rushOffRank: 16, passOffRank: 21, rushDefRank: 3, passDefRank: 2 },
            "Miami Dolphins": { rushOffRank: 17, passOffRank: 28, rushDefRank: 9, passDefRank: 8 },
            "Seattle Seahawks": { rushOffRank: 18, passOffRank: 8, rushDefRank: 7, passDefRank: 17 },
            "Los Angeles Rams": { rushOffRank: 19, passOffRank: 6, rushDefRank: 17, passDefRank: 15 },
            "Kansas City Chiefs": { rushOffRank: 20, passOffRank: 17, rushDefRank: 16, passDefRank: 19 },
            "Indianapolis Colts": { rushOffRank: 21, passOffRank: 19, rushDefRank: 13, passDefRank: 13 },
            "Houston Texans": { rushOffRank: 22, passOffRank: 20, rushDefRank: 12, passDefRank: 5 },
            "Cincinnati Bengals": { rushOffRank: 23, passOffRank: 4, rushDefRank: 28, passDefRank: 26 },
            "New Orleans Saints": { rushOffRank: 24, passOffRank: 15, rushDefRank: 18, passDefRank: 22 },
            "Tennessee Titans": { rushOffRank: 25, passOffRank: 26, rushDefRank: 21, passDefRank: 21 },
            "Jacksonville Jaguars": { rushOffRank: 26, passOffRank: 22, rushDefRank: 31, passDefRank: 30 },
            "Cleveland Browns": { rushOffRank: 27, passOffRank: 29, rushDefRank: 20, passDefRank: 11 },
            "Carolina Panthers": { rushOffRank: 28, passOffRank: 27, rushDefRank: 24, passDefRank: 14 },
            "New England Patriots": { rushOffRank: 29, passOffRank: 30, rushDefRank: 27, passDefRank: 29 },
            "Las Vegas Raiders": { rushOffRank: 30, passOffRank: 24, rushDefRank: 29, passDefRank: 31 },
            "New York Giants": { rushOffRank: 31, passOffRank: 32, rushDefRank: 30, passDefRank: 23 },
            "New York Jets": { rushOffRank: 32, passOffRank: 31, rushDefRank: 32, passDefRank: 32 }
        };

        // League stats cache (fetched dynamically with hardcoded fallback)
        let leagueStats = {
            teams: {},
            rankings: {},
            hasData: false
        };

        let injuries = {};

        // ===== INITIALIZATION =====
        if (apiKey) {
            document.getElementById('apiKeyInput').value = apiKey;
            document.getElementById('apiSetup').style.display = 'none';
            loadAllData();
        }

        updateAccuracyDisplay();

        function saveApiKey() {
            const input = document.getElementById('apiKeyInput');
            apiKey = input.value.trim();
            if (apiKey) {
                localStorage.setItem('nfl_odds_api_key', apiKey);
                document.getElementById('apiSetup').style.display = 'none';
                loadAllData();
            } else {
                showError('Please enter a valid API key');
            }
        }

        function showError(message) {
            const errorEl = document.getElementById('error');
            errorEl.textContent = message;
            errorEl.style.display = 'block';
            setTimeout(() => errorEl.style.display = 'none', 10000);
        }

        function updateAccuracyDisplay() {
            document.getElementById('correct').textContent = accuracyStats.correct;
            document.getElementById('total').textContent = accuracyStats.total;
            const accuracy = accuracyStats.total > 0 ? ((accuracyStats.correct / accuracyStats.total) * 100).toFixed(1) : 0;
            document.getElementById('accuracy').textContent = accuracy + '%';
        }

        // ===== MAIN DATA LOADING =====
        async function loadAllData() {
            try {
                document.getElementById('loading').textContent = 'üèà Loading NFL data...';
                console.log('=== STARTING DATA LOAD ===');

                // Step 1: Fetch league-wide team stats
                await fetchLeagueStats();

                // Step 2: Fetch injuries
                await fetchInjuries();

                // Step 3: Fetch upcoming games
                const games = await fetchGames();

                if (games.length === 0) {
                    document.getElementById('loading').textContent = 'No upcoming games in the next 7 days';
                    return;
                }

                // Step 4: Fetch odds
                let oddsData = [];
                try {
                    oddsData = await fetchOdds();
                } catch (e) {
                    console.warn('Could not fetch odds:', e.message);
                }

                // Step 5: Check past predictions
                await checkPredictionResults();
                updateAccuracyDisplay();

                // Step 6: Display games with predictions
                await displayGames(games, oddsData);

                document.getElementById('loading').style.display = 'none';
                console.log('=== DATA LOAD COMPLETE ===');
            } catch (error) {
                console.error('Error loading data:', error);
                showError('Failed to load data: ' + error.message);
                document.getElementById('loading').textContent = 'Error loading data. Check console.';
            }
        }

        // ===== FETCH LEAGUE STATS =====
async function fetchLeagueStats() {
    console.log('üìä Fetching team rankings and PPG from ESPN...');

    const proxy = url => `https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`;

    const urls = {
        rushOff: 'https://www.espn.com/nfl/stats/team/_/view/offense/season/2025/seasontype/2/table/rushing/sort/rushingYardsPerGame/dir/desc',
        passOff: 'https://www.espn.com/nfl/stats/team/_/view/offense/season/2025/seasontype/2/table/passing/sort/netPassingYardsPerGame/dir/desc',
        rushDef: 'https://www.espn.com/nfl/stats/team/_/view/defense/season/2025/seasontype/2/table/rushing/sort/rushingYardsPerGame/dir/asc',
        passDef: 'https://www.espn.com/nfl/stats/team/_/view/defense/season/2025/seasontype/2/table/passing/sort/netPassingYardsPerGame/dir/asc',
        offPPG: 'https://www.espn.com/nfl/stats/team/_/view/offense/season/2025/seasontype/2',
        defPPG: 'https://www.espn.com/nfl/stats/team/_/view/defense/season/2025/seasontype/2'
    };

    async function parseRankings(html) {
        const parser = new DOMParser();
        const doc = parser.parseFromString(html, 'text/html');
        const rows = doc.querySelectorAll('.Table__TBODY .Table__TR');
        const data = {};
        rows.forEach(row => {
            const tds = row.querySelectorAll('.Table__TD');
            if (tds.length > 1) {
                const rk = parseInt(tds[0].textContent.trim()) || 999;
                const teamLink = tds[1].querySelector('.AnchorLink');
                const teamName = teamLink ? teamLink.textContent.trim() : tds[1].textContent.trim();
                data[teamName] = rk;
            }
        });
        return data;
    }

    async function parsePPG(html) {
        const parser = new DOMParser();
        const doc = parser.parseFromString(html, 'text/html');
        const rows = doc.querySelectorAll('.Table__TBODY .Table__TR');
        const data = {};
        rows.forEach(row => {
            const tds = row.querySelectorAll('.Table__TD');
            if (tds.length >= 5) {
                const teamLink = tds[1].querySelector('.AnchorLink');
                const teamName = teamLink ? teamLink.textContent.trim() : tds[1].textContent.trim();
                let ptsG = 0;
                // Search columns for realistic PPG (15-35 range)
                for (let i = 3; i < tds.length; i++) {  // Start after PTS total
                    const val = parseFloat(tds[i].textContent.trim());
                    if (!isNaN(val) && val >= 15 && val <= 35) {
                        ptsG = val;
                        break;
                    }
                }
                if (ptsG > 0) data[teamName] = ptsG;
            }
        });
        return data;
    }

    try {
        const responses = await Promise.all([
            fetch(proxy(urls.rushOff)).then(r => r.ok ? r.text() : null),
            fetch(proxy(urls.passOff)).then(r => r.ok ? r.text() : null),
            fetch(proxy(urls.rushDef)).then(r => r.ok ? r.text() : null),
            fetch(proxy(urls.passDef)).then(r => r.ok ? r.text() : null),
            fetch(proxy(urls.offPPG)).then(r => r.ok ? r.text() : null),
            fetch(proxy(urls.defPPG)).then(r => r.ok ? r.text() : null)
        ]);

        const rushOff = responses[0] ? await parseRankings(responses[0]) : null;
        const passOff = responses[1] ? await parseRankings(responses[1]) : null;
        const rushDef = responses[2] ? await parseRankings(responses[2]) : null;
        const passDef = responses[3] ? await parseRankings(responses[3]) : null;
        const offPPG = responses[4] ? await parsePPG(responses[4]) : null;
        const defPPG = responses[5] ? await parsePPG(responses[5]) : null;

        leagueStats.rankings = {};
        leagueStats.ppg = { off: {}, def: {} };

        for (const team in TEAM_DATA) {
            leagueStats.rankings[team] = {
                rushOffRank: rushOff?.[team] || HARDCODED_RANKINGS_2025[team]?.rushOffRank || 16,
                passOffRank: passOff?.[team] || HARDCODED_RANKINGS_2025[team]?.passOffRank || 16,
                rushDefRank: rushDef?.[team] || HARDCODED_RANKINGS_2025[team]?.rushDefRank || 16,
                passDefRank: passDef?.[team] || HARDCODED_RANKINGS_2025[team]?.passDefRank || 16
            };

            leagueStats.ppg.off[team] = offPPG?.[team] || null;
            leagueStats.ppg.def[team] = defPPG?.[team] || null;

            // If no real PPG, use refined rank estimate
            if (!leagueStats.ppg.off[team]) {
                const avgOff = (leagueStats.rankings[team].rushOffRank + leagueStats.rankings[team].passOffRank) / 2;
                leagueStats.ppg.off[team] = 30 - (avgOff - 1) * (15 / 31);
            }
            if (!leagueStats.ppg.def[team]) {
                const avgDef = (leagueStats.rankings[team].rushDefRank + leagueStats.rankings[team].passDefRank) / 2;
                leagueStats.ppg.def[team] = 15 + (avgDef - 1) * (15 / 31);
            }
        }

        leagueStats.hasData = true;
        console.log(`‚úÖ Loaded stats (real PPG where available)`);
        console.log('Sample PPG:', 'Vikings Off:', leagueStats.ppg.off['Minnesota Vikings'], 'Cowboys Def:', leagueStats.ppg.def['Dallas Cowboys']);
    } catch (e) {
        console.warn('Dynamic fetch failed, using full fallback:', e);
        // Full hardcoded fallback as before
        leagueStats.rankings = HARDCODED_RANKINGS_2025;
        leagueStats.ppg = { off: {}, def: {} };
        for (const team in TEAM_DATA) {
            const avgOff = (HARDCODED_RANKINGS_2025[team].rushOffRank + HARDCODED_RANKINGS_2025[team].passOffRank) / 2;
            const avgDef = (HARDCODED_RANKINGS_2025[team].rushDefRank + HARDCODED_RANKINGS_2025[team].passDefRank) / 2;
            leagueStats.ppg.off[team] = 30 - (avgOff - 1) * (15 / 31);
            leagueStats.ppg.def[team] = 15 + (avgDef - 1) * (15 / 31);
        }
        leagueStats.hasData = true;
    }
}

        // ===== FETCH INJURIES =====
        async function fetchInjuries() {
            console.log('üè• Fetching injuries from ESPN...');

            try {
                const response = await fetch('https://site.api.espn.com/apis/site/v2/sports/football/nfl/news?limit=100');
                const data = await response.json();

                for (const article of data.articles || []) {
                    if (article.headline.toLowerCase().includes('injury') ||
                        article.headline.toLowerCase().includes('out') ||
                        article.headline.toLowerCase().includes('questionable')) {

                        for (const teamName in TEAM_DATA) {
                            if (article.headline.includes(teamName) ||
                                (article.description && article.description.includes(teamName))) {

                                if (!injuries[teamName]) {
                                    injuries[teamName] = [];
                                }

                                injuries[teamName].push({
                                    headline: article.headline,
                                    link: article.links?.web?.href || '#',
                                    description: article.description || ''
                                });
                            }
                        }
                    }
                }

                console.log(`‚úÖ Found injury reports for ${Object.keys(injuries).length} teams`);
            } catch (error) {
                console.warn('Could not fetch injuries:', error.message);
            }
        }

        // ===== FETCH GAMES =====
        async function fetchGames() {
            console.log('üì• Fetching games from ESPN...');

            const games = [];
            const now = new Date();
            const sevenDaysFromNow = new Date(now.getTime() + 7 * 24 * 60 * 60 * 1000);

            const response = await fetch('https://site.api.espn.com/apis/site/v2/sports/football/nfl/scoreboard');
            const data = await response.json();

            if (data.week && data.week.number) {
                document.getElementById('weekIndicator').textContent = `Week ${data.week.number}`;
            }

            for (const event of data.events || []) {
                const gameDate = new Date(event.date);
                if (gameDate > now && gameDate < sevenDaysFromNow) {
                    games.push(event);
                }
            }

            console.log(`‚úÖ Found ${games.length} upcoming games`);
            return games;
        }

        // ===== FETCH ODDS =====
        async function fetchOdds() {
            if (!apiKey) return [];

            console.log('üí∞ Fetching odds...');
            const response = await fetch(`https://api.the-odds-api.com/v4/sports/americanfootball_nfl/odds/?apiKey=${apiKey}&regions=us&markets=spreads,totals,h2h`);

            if (!response.ok) {
                throw new Error('Failed to fetch odds');
            }

            const data = await response.json();
            console.log(`‚úÖ Fetched odds for ${data.length} games`);
            return data;
        }

        // ===== FETCH WEATHER =====
        async function fetchWeather(homeTeam, gameDate) {
            const teamInfo = TEAM_DATA[homeTeam];
            if (!teamInfo) return null;

            try {
                const date = new Date(gameDate);
                const dateStr = date.toISOString().split('T')[0];

                const url = `https://api.open-meteo.com/v1/forecast?latitude=${teamInfo.lat}&longitude=${teamInfo.lon}&hourly=temperature_2m,precipitation_probability,windspeed_10m,weathercode&temperature_unit=fahrenheit&windspeed_unit=mph&timezone=America/New_York&start_date=${dateStr}&end_date=${dateStr}`;

                const response = await fetch(url);
                const data = await response.json();

                const hour = date.getHours();
                const temp = data.hourly.temperature_2m[hour] || 70;
                const precip = data.hourly.precipitation_probability[hour] || 0;
                const wind = data.hourly.windspeed_10m[hour] || 0;
                const code = data.hourly.weathercode[hour] || 0;

                let condition = 'Clear';
                let rain = 0;
                let snow = 0;

                if (code >= 71 && code <= 77) { condition = 'Snow'; snow = 1; }
                else if (code >= 61 && code <= 67) { condition = 'Rain'; rain = 0.5; }
                else if (code >= 80 && code <= 99) { condition = 'Heavy Rain'; rain = 1; }
                else if (code >= 45 && code <= 48) condition = 'Fog';

                return {
                    temp: Math.round(temp),
                    precipitation: precip,
                    windSpeed: Math.round(wind),
                    condition,
                    rain,
                    snow
                };
            } catch (error) {
                console.warn('Weather fetch failed:', error.message);
                return null;
            }
        }

        // ===== ANALYZE INJURY IMPACT =====
        function analyzeInjuryImpact(teamName) {
            const teamInjuries = injuries[teamName] || [];
            let impact = { points: 0, notes: [] };

            for (const injury of teamInjuries) {
                const text = (injury.headline + ' ' + injury.description).toLowerCase();

                // QB injuries - huge impact
                if (text.includes('quarterback') || text.includes(' qb ')) {
                    if (text.includes('out') || text.includes('ruled out')) {
                        impact.points -= 8;
                        impact.notes.push('Starting QB out (-8 pts)');
                    } else if (text.includes('questionable') || text.includes('doubtful')) {
                        impact.points -= 4;
                        impact.notes.push('Starting QB questionable (-4 pts)');
                    }
                }

                // RB injuries - big impact
                else if (text.includes('running back') || text.includes(' rb ')) {
                    if (text.includes('out') || text.includes('ruled out')) {
                        impact.points -= 4;
                        impact.notes.push('Key RB out (-4 pts)');
                    } else if (text.includes('questionable')) {
                        impact.points -= 2;
                        impact.notes.push('Key RB questionable (-2 pts)');
                    }
                }

                // WR injuries - significant for passing
                else if (text.includes('wide receiver') || text.includes(' wr ') || text.includes('receiver')) {
                    if (text.includes('out') || text.includes('ruled out')) {
                        impact.points -= 3;
                        impact.notes.push('Key WR out (-3 pts)');
                    } else if (text.includes('questionable')) {
                        impact.points -= 1.5;
                        impact.notes.push('Key WR questionable (-1.5 pts)');
                    }
                }
            }

            return impact;
        }

        // ===== GENERATE PREDICTION (DEVIATION ANALYSIS) =====
        function generatePrediction(game, odds, weather) {
            const competition = game.competitions[0];
            const homeComp = competition.competitors.find(c => c.homeAway === 'home');
            const awayComp = competition.competitors.find(c => c.homeAway === 'away');

            const homeTeam = homeComp.team.displayName;
            const awayTeam = awayComp.team.displayName;

            const homeRecord = homeComp.records?.[0]?.summary || '0-0';
            const awayRecord = awayComp.records?.[0]?.summary || '0-0';

            const homeRankings = leagueStats.rankings[homeTeam] || {};
            const awayRankings = leagueStats.rankings[awayTeam] || {};

            let prediction = {
                homeTeam,
                awayTeam,
                homeRecord,
                awayRecord,
                vegasSpread: 'N/A',
                vegasTotal: 'N/A',
                vegasHomeScore: null,
                vegasAwayScore: null,
                weather: weather,
                rationale: [],
                edges: [],
                calculations: [],
                deviation: [],
                injuries: {
                    home: injuries[homeTeam] || [],
                    away: injuries[awayTeam] || []
                }
            };

            // Parse Vegas odds (for comparison only, NOT as base)
            if (odds) {
                const spreadsMarket = odds.bookmakers?.[0]?.markets?.find(m => m.key === 'spreads');
                const totalsMarket = odds.bookmakers?.[0]?.markets?.find(m => m.key === 'totals');

                if (spreadsMarket) {
                    const homeSpread = spreadsMarket.outcomes.find(o => o.name === homeTeam);
                    prediction.vegasSpread = homeSpread?.point || 'N/A';
                }
                if (totalsMarket) {
                    prediction.vegasTotal = totalsMarket.outcomes[0]?.point || 'N/A';
                }

                // Calculate Vegas implied scores
                if (prediction.vegasSpread !== 'N/A' && prediction.vegasTotal !== 'N/A') {
                    const spread = parseFloat(prediction.vegasSpread);
                    const total = parseFloat(prediction.vegasTotal);
                    prediction.vegasHomeScore = Math.round((total - spread) / 2);
                    prediction.vegasAwayScore = Math.round((total + spread) / 2);
                }
            }

            // ===== NEW: PPG-BASED EFFICIENCY PROJECTION =====
            let ourHomeScore = 23;
            let ourAwayScore = 23;

            if (leagueStats.hasData && leagueStats.ppg) {
                const homeOffPPG = leagueStats.ppg.off[homeTeam] || 23;
                const homeDefPPG = leagueStats.ppg.def[homeTeam] || 23;
                const awayOffPPG = leagueStats.ppg.off[awayTeam] || 23;
                const awayDefPPG = leagueStats.ppg.def[awayTeam] || 23;

                ourAwayScore = (awayOffPPG + homeDefPPG) / 2;
                ourHomeScore = (homeOffPPG + awayDefPPG) / 2;

                prediction.calculations.push(`Base efficiency projection:`);
                prediction.calculations.push(`  ${awayTeam} offense (${awayOffPPG.toFixed(1)} PPG) vs ${homeTeam} defense (${homeDefPPG.toFixed(1)} PA/G) ‚Üí ${awayTeam} ${ourAwayScore.toFixed(1)} pts`);
                prediction.calculations.push(`  ${homeTeam} offense (${homeOffPPG.toFixed(1)} PPG) vs ${awayTeam} defense (${awayDefPPG.toFixed(1)} PA/G) ‚Üí ${homeTeam} ${ourHomeScore.toFixed(1)} pts`);
            } else {
                prediction.calculations.push(`Base projection: Using fallback estimates`);
            }

            // Home field advantage
            ourHomeScore += 2.5;
            prediction.calculations.push(`Home field advantage: +2.5 pts to ${homeTeam}`);

            // Win percentage for confidence only (record strength indicator)
            const [homeWins, homeLosses] = homeRecord.split('-').map(n => parseInt(n) || 0);
            const [awayWins, awayLosses] = awayRecord.split('-').map(n => parseInt(n) || 0);
            const totalHome = homeWins + homeLosses;
            const totalAway = awayWins + awayLosses;
            const homeWinPct = totalHome > 0 ? homeWins / totalHome : 0.5;
            const awayWinPct = totalAway > 0 ? awayWins / totalAway : 0.5;

            if (Math.abs(homeWinPct - awayWinPct) > 0.3) {
                prediction.calculations.push(`Large record gap: ${(Math.max(homeWinPct, awayWinPct)*100).toFixed(0)}% vs ${(Math.min(homeWinPct, awayWinPct)*100).toFixed(0)}%`);
            }

            // ===== MATCHUP DIFFERENTIAL (FIXED CALCULATION) =====
            let rushWeight = 1;
            let passWeight = 1;

            if (weather) {
                if (weather.snow) {
                    rushWeight = 2.5;
                    passWeight = 0.4;
                    prediction.calculations.push(`${weather.condition}: Rush √ó2.5, Pass √ó0.4`);
                } else if (weather.rain > 0.5) {
                    rushWeight = 1.8;
                    passWeight = 0.6;
                    prediction.calculations.push(`${weather.condition}: Rush √ó1.8, Pass √ó0.6`);
                }

                if (weather.windSpeed > 20) {
                    passWeight *= 0.4;
                    prediction.calculations.push(`High winds (${weather.windSpeed}mph): Pass √ó0.4`);
                }
            }

            if (leagueStats.hasData) {
                // Home rush offense vs away rush defense
                if (homeRankings.rushOffRank && awayRankings.rushDefRank) {
                    const gap = awayRankings.rushDefRank - homeRankings.rushOffRank;
                    const rawAdvantage = gap * 0.15; // 0.15 pts per rank difference
                    const advantage = rawAdvantage * rushWeight;
                    ourHomeScore += advantage;

                    if (Math.abs(gap) > 5) {
                        const favored = gap > 0 ? homeTeam : awayTeam;
                        prediction.calculations.push(`${homeTeam} #${homeRankings.rushOffRank} rush O vs ${awayTeam} #${awayRankings.rushDefRank} rush D: ${advantage > 0 ? '+' : ''}${advantage.toFixed(1)} pts`);
                        if (Math.abs(gap) > 10) {
                            prediction.edges.push(`${favored} rush matchup advantage`);
                        }
                    }
                }

                // Home pass offense vs away pass defense
                if (homeRankings.passOffRank && awayRankings.passDefRank) {
                    const gap = awayRankings.passDefRank - homeRankings.passOffRank;
                    const rawAdvantage = gap * 0.15;
                    const advantage = rawAdvantage * passWeight;
                    ourHomeScore += advantage;

                    if (Math.abs(gap) > 5) {
                        const favored = gap > 0 ? homeTeam : awayTeam;
                        prediction.calculations.push(`${homeTeam} #${homeRankings.passOffRank} pass O vs ${awayTeam} #${awayRankings.passDefRank} pass D: ${advantage > 0 ? '+' : ''}${advantage.toFixed(1)} pts`);
                        if (Math.abs(gap) > 10) {
                            prediction.edges.push(`${favored} pass matchup advantage`);
                        }
                    }
                }

                // Away rush offense vs home rush defense
                if (awayRankings.rushOffRank && homeRankings.rushDefRank) {
                    const gap = homeRankings.rushDefRank - awayRankings.rushOffRank;
                    const rawAdvantage = gap * 0.15;
                    const advantage = rawAdvantage * rushWeight;
                    ourAwayScore += advantage;

                    if (Math.abs(gap) > 5) {
                        const favored = gap > 0 ? awayTeam : homeTeam;
                        prediction.calculations.push(`${awayTeam} #${awayRankings.rushOffRank} rush O vs ${homeTeam} #${homeRankings.rushDefRank} rush D: ${advantage > 0 ? '+' : ''}${advantage.toFixed(1)} pts`);
                        if (Math.abs(gap) > 10) {
                            prediction.edges.push(`${favored} rush matchup advantage`);
                        }
                    }
                }

                // Away pass offense vs home pass defense
                if (awayRankings.passOffRank && homeRankings.passDefRank) {
                    const gap = homeRankings.passDefRank - awayRankings.passOffRank;
                    const rawAdvantage = gap * 0.15;
                    const advantage = rawAdvantage * passWeight;
                    ourAwayScore += advantage;

                    if (Math.abs(gap) > 5) {
                        const favored = gap > 0 ? awayTeam : homeTeam;
                        prediction.calculations.push(`${awayTeam} #${awayRankings.passOffRank} pass O vs ${homeTeam} #${homeRankings.passDefRank} pass D: ${advantage > 0 ? '+' : ''}${advantage.toFixed(1)} pts`);
                        if (Math.abs(gap) > 10) {
                            prediction.edges.push(`${favored} pass matchup advantage`);
                        }
                    }
                }
            }

            // ===== INJURY IMPACT =====
            const homeInjuryImpact = analyzeInjuryImpact(homeTeam);
            const awayInjuryImpact = analyzeInjuryImpact(awayTeam);

            if (homeInjuryImpact.points !== 0) {
                ourHomeScore += homeInjuryImpact.points;
                homeInjuryImpact.notes.forEach(note => prediction.calculations.push(`${homeTeam}: ${note}`));
            }

            if (awayInjuryImpact.points !== 0) {
                ourAwayScore += awayInjuryImpact.points;
                awayInjuryImpact.notes.forEach(note => prediction.calculations.push(`${awayTeam}: ${note}`));
            }

            // Finalize our prediction
            prediction.homeScore = Math.max(10, Math.round(ourHomeScore));
            prediction.awayScore = Math.max(10, Math.round(ourAwayScore));

            if (prediction.homeScore === prediction.awayScore) {
                prediction.homeScore += 1;
                prediction.calculations.push(`Tie-breaker: +1 to ${homeTeam}`);
            }

            prediction.winner = prediction.homeScore > prediction.awayScore ? homeTeam : awayTeam;
            const margin = Math.abs(prediction.homeScore - prediction.awayScore);

            // ===== DEVIATION ANALYSIS (Compare to Vegas) =====
            if (prediction.vegasHomeScore && prediction.vegasAwayScore) {
                const scoreDiff = (prediction.homeScore - prediction.awayScore) - (prediction.vegasHomeScore - prediction.vegasAwayScore);
                const totalDiff = (prediction.homeScore + prediction.awayScore) - (prediction.vegasHomeScore + prediction.vegasAwayScore);

                prediction.deviation.push(`Our prediction: ${homeTeam} ${prediction.homeScore}, ${awayTeam} ${prediction.awayScore}`);
                prediction.deviation.push(`Vegas prediction: ${homeTeam} ${prediction.vegasHomeScore}, ${awayTeam} ${prediction.vegasAwayScore}`);

                if (Math.abs(scoreDiff) > 3) {
                    const favorsTeam = scoreDiff > 0 ? homeTeam : awayTeam;
                    prediction.deviation.push(`üî• We favor ${favorsTeam} ${Math.abs(scoreDiff).toFixed(1)} pts more than Vegas`);
                    prediction.rationale.push(`Significant deviation from Vegas (${Math.abs(scoreDiff).toFixed(1)} pt difference)`);
                } else {
                    prediction.deviation.push(`‚úì Close agreement with Vegas (${Math.abs(scoreDiff).toFixed(1)} pt difference)`);
                }

                if (Math.abs(totalDiff) > 6) {
                    const direction = totalDiff > 0 ? 'OVER' : 'UNDER';
                    prediction.deviation.push(`üìä ${direction} Vegas total by ${Math.abs(totalDiff).toFixed(1)} pts`);
                }
            }

            // Build rationale
            prediction.rationale.push(`${prediction.winner} by ${margin} points (our model)`);

            if (prediction.vegasSpread !== 'N/A') {
                const vegasFav = parseFloat(prediction.vegasSpread) < 0 ? homeTeam : awayTeam;
                prediction.rationale.push(`Vegas: ${vegasFav} by ${Math.abs(parseFloat(prediction.vegasSpread))} pts`);
            }

            const winnerWinPct = prediction.winner === homeTeam ? homeWinPct : awayWinPct;
            if (winnerWinPct > 0.65) {
                prediction.rationale.push(`${prediction.winner} strong record (${(winnerWinPct * 100).toFixed(0)}%)`);
            }

            // Confidence based on model strength, NOT Vegas agreement
            let confidenceScore = margin;
            if (prediction.edges.length >= 2) confidenceScore += 5;
            if (prediction.edges.length >= 3) confidenceScore += 3;
            if (winnerWinPct > 0.7) confidenceScore += 4;
            if (Math.abs(homeWinPct - awayWinPct) > 0.3) confidenceScore += 3;

            if (confidenceScore >= 14) prediction.confidence = 'High';
            else if (confidenceScore >= 8) prediction.confidence = 'Medium';
            else prediction.confidence = 'Low';

            return prediction;
        }

        // ===== DISPLAY GAMES =====
        async function displayGames(games, oddsData) {
            const gamesContainer = document.getElementById('games');
            const picksList = document.getElementById('picks-list');
            const picksSummary = document.getElementById('picksummary');

            gamesContainer.innerHTML = '';
            picksList.innerHTML = '';

            if (games.length === 0) {
                gamesContainer.innerHTML = '<div style="text-align: center; padding: 3rem;">No upcoming games</div>';
                return;
            }

            const gamesWithPredictions = [];

            for (const game of games) {
                const competition = game.competitions[0];
                const homeComp = competition.competitors.find(c => c.homeAway === 'home');
                const homeTeam = homeComp.team.displayName;

                const gameOdds = oddsData.find(o =>
                    o.home_team === homeTeam ||
                    (o.home_team.includes(homeTeam.split(' ').pop()) && o.commence_time &&
                     Math.abs(new Date(o.commence_time) - new Date(game.date)) < 3600000)
                );

                const weather = await fetchWeather(homeTeam, game.date);
                const prediction = generatePrediction(game, gameOdds, weather);

                const gameId = game.id;
                savePrediction(gameId, game.date, prediction);

                gamesWithPredictions.push({ game, prediction, gameId });
            }

            const confidenceOrder = { 'High': 0, 'Medium': 1, 'Low': 2 };
            gamesWithPredictions.sort((a, b) => {
                const dateA = new Date(a.game.date);
                const dateB = new Date(b.game.date);
                if (dateA.toDateString() !== dateB.toDateString()) {
                    return dateA - dateB;
                }
                return confidenceOrder[a.prediction.confidence] - confidenceOrder[b.prediction.confidence];
            });

            gamesWithPredictions.forEach(({ prediction, gameId }) => {
                const teamColor = TEAM_DATA[prediction.winner]?.color || '#3498db';
                const loser = prediction.winner === prediction.homeTeam ? prediction.awayTeam : prediction.homeTeam;

                picksList.innerHTML += `
                    <div onclick="document.getElementById('${gameId}').scrollIntoView({behavior: 'smooth', block: 'center'})"
                         style="background: rgba(255,255,255,0.05); padding: 0.75rem; border-radius: 0.5rem; cursor: pointer; border-left: 4px solid ${teamColor}; transition: all 0.2s;"
                         onmouseover="this.style.background='rgba(255,255,255,0.1)'"
                         onmouseout="this.style.background='rgba(255,255,255,0.05)'">
                        <div style="font-weight: bold; font-size: 1.1rem;">${prediction.winner}</div>
                        <div style="font-size: 0.85rem; opacity: 0.9;">over ${loser}</div>
                        <div style="font-size: 0.75rem; opacity: 0.8; margin-top: 0.25rem;">
                            ${prediction.homeScore}-${prediction.awayScore} ‚Ä¢ ${prediction.confidence}
                        </div>
                    </div>
                `;
            });
            picksSummary.style.display = 'block';

            gamesWithPredictions.forEach(({ game, prediction, gameId }) => {
                gamesContainer.innerHTML += createGameCard(game, prediction, gameId);
            });
        }

        function createGameCard(game, prediction, gameId) {
            const awayRankings = leagueStats.rankings[prediction.awayTeam] || { rushOffRank: '-', passOffRank: '-', rushDefRank: '-', passDefRank: '-' };
            const homeRankings = leagueStats.rankings[prediction.homeTeam] || { rushOffRank: '-', passOffRank: '-', rushDefRank: '-', passDefRank: '-' };

            // Safe display values (avoid undefined)
            const awayRushO = awayRankings.rushOffRank || '-';
            const awayPassO = awayRankings.passOffRank || '-';
            const awayRushD = awayRankings.rushDefRank || '-';
            const awayPassD = awayRankings.passDefRank || '-';
            const homeRushO = homeRankings.rushOffRank || '-';
            const homePassO = homeRankings.passOffRank || '-';
            const homeRushD = homeRankings.rushDefRank || '-';
            const homePassD = homeRankings.passDefRank || '-';
            const teamColor = TEAM_DATA[prediction.homeTeam]?.color || '#3498db';
            const homeLogo = TEAM_DATA[prediction.homeTeam]?.logo;
            const awayLogo = TEAM_DATA[prediction.awayTeam]?.logo;

            const gameDate = new Date(game.date);
            const gameTime = gameDate.toLocaleDateString('en-US', {
                weekday: 'short',
                month: 'short',
                day: 'numeric',
                hour: 'numeric',
                minute: '2-digit'
            });

            const confidenceClass = `confidence-${prediction.confidence.toLowerCase()}`;

            let weatherHTML = '';
            if (prediction.weather) {
                const w = prediction.weather;
                let weatherIcon = '‚òÄÔ∏è';
                if (w.condition === 'Snow') weatherIcon = '‚ùÑÔ∏è';
                else if (w.condition.includes('Rain')) weatherIcon = 'üåßÔ∏è';
                else if (w.condition === 'Fog') weatherIcon = 'üå´Ô∏è';

                weatherHTML = `<div class="badge" style="background: rgba(255,255,255,0.2);">${weatherIcon} ${w.temp}¬∞F ${w.condition}${w.windSpeed > 15 ? ` ‚Ä¢ ${w.windSpeed}mph` : ''}</div>`;
            }

            // Removed fallback badge - using reliable hardcoded rankings

            let rationaleHTML = '';
            if (prediction.rationale.length > 0) {
                rationaleHTML = '<div class="rationale"><strong>Summary:</strong>';
                prediction.rationale.forEach(reason => {
                    rationaleHTML += `<div class="rationale-item">‚Ä¢ ${reason}</div>`;
                });
                rationaleHTML += '</div>';
            }

            let calculationsHTML = '';
            if (prediction.calculations.length > 0) {
                calculationsHTML = '<div class="rationale" style="margin-top: 1rem;"><strong>How We Calculated This:</strong>';
                prediction.calculations.forEach(calc => {
                    calculationsHTML += `<div class="rationale-item">‚Üí ${calc}</div>`;
                });
                calculationsHTML += '</div>';
            }

            let deviationHTML = '';
            if (prediction.deviation && prediction.deviation.length > 0) {
                deviationHTML = '<div class="rationale" style="margin-top: 1rem; background: rgba(52, 152, 219, 0.15);"><strong>üìä Deviation from Vegas:</strong>';
                prediction.deviation.forEach(dev => {
                    deviationHTML += `<div class="rationale-item">‚Üí ${dev}</div>`;
                });
                deviationHTML += '</div>';
            }

            let edgesHTML = '';
            if (prediction.edges.length > 0) {
                edgesHTML = '<div class="prediction-section"><div class="prediction-title">‚ö° Key Matchup Edges</div>';
                prediction.edges.forEach(edge => {
                    edgesHTML += `<div class="matchup-edge"><div class="edge-item">üî• ${edge}</div></div>`;
                });
                edgesHTML += '</div>';
            }

            let injuryHTML = '';
            if (prediction.injuries.home.length > 0 || prediction.injuries.away.length > 0) {
                injuryHTML = '<div class="prediction-section"><div class="prediction-title">üè• Key Injuries</div>';
                if (prediction.injuries.home.length > 0) {
                    injuryHTML += `<div class="injuries"><strong>${prediction.homeTeam}:</strong>`;
                    prediction.injuries.home.slice(0, 3).forEach(inj => {
                        const truncated = inj.headline.substring(0, 80) + (inj.headline.length > 80 ? '...' : '');
                        injuryHTML += `<div class="injury-item">‚Ä¢ <a href="${inj.link}" target="_blank" rel="noopener noreferrer">${truncated}</a></div>`;
                    });
                    injuryHTML += '</div>';
                }
                if (prediction.injuries.away.length > 0) {
                    injuryHTML += `<div class="injuries"><strong>${prediction.awayTeam}:</strong>`;
                    prediction.injuries.away.slice(0, 3).forEach(inj => {
                        const truncated = inj.headline.substring(0, 80) + (inj.headline.length > 80 ? '...' : '');
                        injuryHTML += `<div class="injury-item">‚Ä¢ <a href="${inj.link}" target="_blank" rel="noopener noreferrer">${truncated}</a></div>`;
                    });
                    injuryHTML += '</div>';
                }
                injuryHTML += '</div>';
            }
            const awayRankings = leagueStats.rankings[prediction.awayTeam] || {};
            const homeRankings = leagueStats.rankings[prediction.homeTeam] || {};
            return `
                <div id="${gameId}" class="game-card" style="background: linear-gradient(135deg, ${teamColor}22 0%, ${teamColor}44 100%); border: 2px solid ${teamColor}88;">
                    <div class="game-header" style="background-color: ${teamColor}ee;">
                        <div class="game-meta">
                            <div class="badge">üìÖ ${gameTime}</div>
                            ${weatherHTML}
                            <div class="badge ${confidenceClass}">${prediction.confidence.toUpperCase()}</div>
                        </div>
                        <div class="teams">
                            <div class="team">
                                ${awayLogo ? `<img src="${awayLogo}" alt="${prediction.awayTeam}" class="team-logo">` : ''}
                                <div>
                                    <div class="team-name">${prediction.awayTeam}</div>
                                    <div class="team-record">${prediction.awayRecord}</div>
                                    <div class="team-stats" style="font-size: 0.75rem; opacity: 0.7;">
                                        Rush O: #${awayRushO} Pass O: #${awayPassO}<br>
                                        Rush D: #${awayRushD} Pass D: #${awayPassD}
                                    </div>
                                </div>
                            </div>
                            <div class="vs">@</div>
                            <div class="team">
                                <div style="text-align: right;">
                                    <div class="team-name">${prediction.homeTeam}</div>
                                    <div class="team-record">${prediction.homeRecord}</div>
                                    <div class="team-stats" style="font-size: 0.75rem; opacity: 0.7; text-align: right;">
                                        Rush O: #${homeRushO} Pass O: #${homePassO}<br>
                                        Rush D: #${homeRushD} Pass D: #${homePassD}
                                    </div>
                                </div>
                                ${homeLogo ? `<img src="${homeLogo}" alt="${prediction.homeTeam}" class="team-logo">` : ''}
                            </div>
                        </div>
                    </div>
                    <div class="game-body">
                        <div class="winner-section">
                            <div class="winner-label">üéØ OUR PREDICTION</div>
                            <div class="winner-name">${prediction.winner}</div>
                            <div class="confidence">Confidence: ${prediction.confidence}</div>
                            ${rationaleHTML}
                            ${deviationHTML}
                            ${calculationsHTML}
                        </div>

                        ${edgesHTML}
                        ${injuryHTML}

                        <div class="prediction-section">
                            <div class="prediction-title">üìä Score Predictions</div>
                            <div class="prediction-grid">
                                <div class="pred-stat">
                                    <div class="pred-label">Our Model</div>
                                    <div class="pred-value" style="font-size: 1.5rem;">${prediction.homeScore} - ${prediction.awayScore}</div>
                                </div>
                                ${prediction.vegasHomeScore ? `
                                <div class="pred-stat">
                                    <div class="pred-label">Vegas Line</div>
                                    <div class="pred-value" style="font-size: 1.5rem; color: #f39c12;">${prediction.vegasHomeScore} - ${prediction.vegasAwayScore}</div>
                                </div>
                                ` : ''}
                            </div>
                        </div>

                        ${prediction.vegasSpread !== 'N/A' ? `
                        <div class="prediction-section">
                            <div class="prediction-title">üí∞ Vegas Betting Lines</div>
                            <div class="stats-breakdown">
                                <div class="stat-row">
                                    <span>Spread:</span>
                                    <strong>${prediction.homeTeam} ${prediction.vegasSpread}</strong>
                                </div>
                                <div class="stat-row">
                                    <span>Over/Under:</span>
                                    <strong>${prediction.vegasTotal}</strong>
                                </div>
                            </div>
                        </div>
                        ` : ''}
                    </div>
                </div>
            `;
        }

        function savePrediction(gameId, gameDate, prediction) {
            const gameTime = new Date(gameDate);
            const now = new Date();

            if (now < gameTime) {
                predictions[gameId] = {
                    date: gameDate,
                    prediction: {
                        winner: prediction.winner,
                        homeTeam: prediction.homeTeam,
                        awayTeam: prediction.awayTeam,
                        homeScore: prediction.homeScore,
                        awayScore: prediction.awayScore
                    }
                };
                localStorage.setItem('nfl_predictions', JSON.stringify(predictions));
            }
        }

        async function checkPredictionResults() {
            const now = new Date();
            const fourHoursAgo = new Date(now.getTime() - 4 * 60 * 60 * 1000);

            for (const gameId in predictions) {
                const pred = predictions[gameId];
                const gameDate = new Date(pred.date);

                if (gameDate < fourHoursAgo && !pred.checked) {
                    try {
                        const response = await fetch(`https://site.api.espn.com/apis/site/v2/sports/football/nfl/summary?event=${gameId}`);
                        const data = await response.json();

                        const competition = data.boxscore?.teams;
                        if (competition && competition.length === 2) {
                            const homeTeam = competition.find(t => t.homeAway === 'home');
                            const awayTeam = competition.find(t => t.homeAway === 'away');

                            const homeScore = parseInt(homeTeam.statistics.find(s => s.name === 'points')?.displayValue || 0);
                            const awayScore = parseInt(awayTeam.statistics.find(s => s.name === 'points')?.displayValue || 0);

                            const actualWinner = homeScore > awayScore ? homeTeam.team.displayName : awayTeam.team.displayName;
                            const predictedWinner = pred.prediction.winner;

                            if (actualWinner === predictedWinner) {
                                accuracyStats.correct++;
                            }
                            accuracyStats.total++;

                            pred.checked = true;
                            predictions[gameId] = pred;
                        }
                    } catch (e) {
                        console.warn(`Could not check result for game ${gameId}`);
                    }
                }
            }

            localStorage.setItem('nfl_predictions', JSON.stringify(predictions));
            localStorage.setItem('nfl_accuracy', JSON.stringify(accuracyStats));
        }

                function saveApiKey() {
            const input = document.getElementById('apiKeyInput');
            const key = input.value.trim();
            
            if (!key) {
                showError('Please enter a valid API key from the-odds-api.com');
                return;
            }

            localStorage.setItem('nfl_odds_api_key', key);
            apiKey = key;
            
            document.getElementById('apiSetup').style.display = 'none';
            document.getElementById('loading').style.display = 'block';
            document.getElementById('loading').textContent = 'Loading schedule and odds...';
            document.getElementById('error').style.display = 'none';

            loadData();
        }

        async function loadData() {
            try {
                await fetchLeagueStats();  // Rankings & PPG first

                const scheduleResponse = await fetch('https://site.api.espn.com/apis/site/v2/sports/football/nfl/scoreboard');
                if (!scheduleResponse.ok) throw new Error('ESPN schedule failed');
                const scheduleData = await scheduleResponse.json();

                const currentWeek = scheduleData.week.number;
                document.getElementById('weekIndicator').textContent = `Week ${currentWeek}`;

                const oddsResponse = await fetch(`https://api.the-odds-api.com/v4/sports/americanfootball_nfl/odds?regions=us&markets=h2h,spreads,totals&apiKey=${apiKey}`);
                if (!oddsResponse.ok) {
                    const errText = await oddsResponse.text();
                    throw new Error(`Odds API error: ${oddsResponse.status} - ${errText}`);
                }
                const oddsData = await oddsResponse.json();

                await displayGames(scheduleData.events, oddsData);
                await checkPredictionResults();  // Update accuracy

                updateAccuracyDisplay();

                document.getElementById('loading').style.display = 'none';
            } catch (err) {
                console.error(err);
                showError(`Failed to load data: ${err.message}<br><br>Check your API key and internet connection. Free keys have rate limits.`);
                document.getElementById('loading').style.display = 'none';
                document.getElementById('apiSetup').style.display = 'block';
            }
        }

        function showError(message) {
            const errorDiv = document.getElementById('error');
            errorDiv.innerHTML = message;
            errorDiv.style.display = 'block';
        }

        function updateAccuracyDisplay() {
            const accuracy = accuracyStats.total > 0 ? ((accuracyStats.correct / accuracyStats.total) * 100).toFixed(1) : 0;
            document.getElementById('correct').textContent = accuracyStats.correct;
            document.getElementById('total').textContent = accuracyStats.total;
            document.getElementById('accuracy').textContent = `${accuracy}%`;
        }

        // Auto-load if key already saved
        if (apiKey) {
            document.getElementById('apiSetup').style.display = 'none';
            loadData();
        } else {
            updateAccuracyDisplay();  // Show 0/0 on fresh load
        }
    </script>
</body>
</html>
