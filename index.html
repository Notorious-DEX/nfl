<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NFL Prediction AI - Enhanced</title>
    <style>
        /* Existing styles unchanged for brevity */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: linear-gradient(135deg, #3d2c5c 0%, #503d72 50%, #3d2c5c 100%); min-height: 100vh; padding: 2rem; color: white; }
        /* ... (keep all original styles) ... */
    </style>
</head>
<body>
    <!-- Existing HTML unchanged -->
    <div class="container">
        <!-- ... (keep header, api-setup, scoreboard, etc.) ... -->
    </div>

    <script>
        const PROXY = 'https://corsproxy.io/?';

        const TEAM_ABBR = {
            "Arizona Cardinals": "ARI", "Atlanta Falcons": "ATL", "Baltimore Ravens": "BAL", "Buffalo Bills": "BUF",
            "Carolina Panthers": "CAR", "Chicago Bears": "CHI", "Cincinnati Bengals": "CIN", "Cleveland Browns": "CLE",
            "Dallas Cowboys": "DAL", "Denver Broncos": "DEN", "Detroit Lions": "DET", "Green Bay Packers": "GB",
            "Houston Texans": "HOU", "Indianapolis Colts": "IND", "Jacksonville Jaguars": "JAX", "Kansas City Chiefs": "KC",
            "Las Vegas Raiders": "LV", "Los Angeles Chargers": "LAC", "Los Angeles Rams": "LAR", "Miami Dolphins": "MIA",
            "Minnesota Vikings": "MIN", "New England Patriots": "NE", "New Orleans Saints": "NO", "New York Giants": "NYG",
            "New York Jets": "NYJ", "Philadelphia Eagles": "PHI", "Pittsburgh Steelers": "PIT", "San Francisco 49ers": "SF",
            "Seattle Seahawks": "SEA", "Tampa Bay Buccaneers": "TB", "Tennessee Titans": "TEN", "Washington Commanders": "WSH"
        };

        const STADIUM_SURFACE = {
            "ARI": "grass", "ATL": "turf", "BAL": "grass", "BUF": "turf", "CAR": "turf", "CHI": "grass",
            "CIN": "turf", "CLE": "grass", "DAL": "turf", "DEN": "grass", "DET": "turf", "GB": "hybrid",
            "HOU": "turf", "IND": "turf", "JAX": "grass", "KC": "grass", "LV": "turf", "LAC": "turf",
            "LAR": "turf", "MIA": "grass", "MIN": "turf", "NE": "turf", "NO": "turf", "NYG": "turf",
            "NYJ": "turf", "PHI": "grass", "PIT": "grass", "SF": "grass", "SEA": "turf", "TB": "grass",
            "TEN": "turf", "WSH": "grass"
        };

        let apiKey = localStorage.getItem('nfl_odds_api_key');
        let gamesData = [];

        async function fetchWithProxy(url) {
            return fetch(PROXY + encodeURIComponent(url)).then(r => r.json());
        }

        async function fetchInjuries() {
            injuries = {};
            for (const team in TEAM_ABBR) {
                const abbr = TEAM_ABBR[team];
                const espnIdMap = { "ARI":1, "ATL":2, "BAL":3, "BUF":4, "CAR":29, "CHI":6, "CIN":7, "CLE":8, "DAL":9, "DEN":10, "DET":11, "GB":12, "HOU":34, "IND":14, "JAX":30, "KC":15, "LV":13, "LAC":24, "LAR":25, "MIA":19, "MIN":20, "NE":21, "NO":22, "NYG":23, "NYJ":26, "PHI":21, "PIT":28, "SF":27, "SEA":26, "TB":27, "TEN":10, "WSH":28 }; // approximate ESPN team IDs
                const id = espnIdMap[abbr] || 1;
                try {
                    const data = await fetchWithProxy(`https://sports.core.api.espn.com/v2/sports/football/leagues/nfl/teams/${id}/injuries`);
                    // Parse key injuries (simplified)
                    injuries[team] = data.items?.slice(0,5).map(i => i.details?.headline) || [];
                } catch(e) {}
            }
        }

        async function fetchWeather(game) {
            const venue = game.competitions[0].venue.fullName;
            const city = venue.split(',')[0]; // rough
            try {
                const data = await fetch(PROXY + encodeURIComponent(`https://nflweather.com/`)); // scrape site or use search, simplified to placeholder
                return { temp: 70, wind: 5, precip: "0%", condition: "clear" }; // placeholder; in practice parse nflweather or openweather
            } catch(e) { return { temp: "Dome", wind: 0, precip: "0%" }; }
        }

        function adjustPrediction(prediction, weather, surface, injuriesCount) {
            // Enhanced adjustments
            if (weather.temp < 32) {
                prediction.homeRBYards += 30; prediction.awayRBYards += 30;
                prediction.homeQBYards -= 40; prediction.awayQBYards -= 40;
            }
            if (weather.wind > 15) {
                prediction.homeQBYards -= 30; prediction.awayQBYards -= 30;
            }
            if (weather.precip !== "0%") {
                prediction.homeRBYards += 20; prediction.awayRBYards += 20;
            }
            // Injury impact stronger
            prediction.homeScore -= injuriesCount.home * 5;
            prediction.awayScore -= injuriesCount.away * 5;

            // Surface historical (simplified bias)
            if (surface === "turf") {
                prediction.homeQBYards += 20; // assume faster
            }

            // Re-calc winner/confidence
            prediction.winner = prediction.homeScore > prediction.awayScore ? prediction.homeTeam : prediction.awayTeam;
            const margin = Math.abs(prediction.homeScore - prediction.awayScore);
            prediction.confidence = margin > 14 ? 'High' : margin > 7 ? 'Medium' : 'Low';
        }

        async function generateSmartPrediction(game, odds) {
            // Existing logic...
            const prediction = { /* existing */ };

            const weather = await fetchWeather(game);
            const surface = STADIUM_SURFACE[TEAM_ABBR[prediction.homeTeam]];
            const injuriesCount = { home: prediction.injuries.home.length, away: prediction.injuries.away.length };

            adjustPrediction(prediction, weather, surface, injuriesCount);

            // Add to card later
            prediction.weather = `${weather.temp}Â°F, Wind ${weather.wind}mph, ${weather.precip} precip`;

            return prediction;
        }

        // Update scheduling
        function scheduleUpdates() {
            setInterval(loadAllData, 12 * 60 * 60 * 1000); // every 12 hours
            // Pre-game: check upcoming games
            setInterval(() => {
                gamesData.forEach(g => {
                    const timeToGame = new Date(g.game.date) - new Date();
                    if (timeToGame > 0 && timeToGame < 15*60*1000 + 60000) { // around 15 min before
                        loadAllData();
                    }
                });
            }, 60000); // check every minute
        }

        async function loadAllData() {
            // Existing fetches...
            await Promise.all([fetchTeamStats(), fetchInjuries()]);
            await fetchGames();
            scheduleUpdates();
        }

        // In displayGames, add weather/injury/surface display sections

        if (apiKey) {
            document.getElementById('apiSetup').style.display = 'none';
            loadAllData();
        }
    </script>
</body>
</html>
