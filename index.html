<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NFL Predictions</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #3d2c5c 0%, #503d72 50%, #3d2c5c 100%);
            min-height: 100vh;
            padding: 1rem;
            color: white;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            margin-bottom: 2rem;
        }

        h1 {
            font-size: clamp(1.5rem, 5vw, 3rem);
            margin-bottom: 0.5rem;
        }

        .week-indicator {
            font-size: clamp(1rem, 3vw, 1.5rem);
            color: #a78bfa;
            font-weight: bold;
            margin-bottom: 0.5rem;
        }

        .subtitle {
            color: #d4c5f9;
            font-size: clamp(0.8rem, 2vw, 1rem);
        }

        .api-setup {
            background: rgba(107, 79, 158, 0.3);
            border: 2px solid rgba(167, 139, 250, 0.5);
            border-radius: 1rem;
            padding: 2rem;
            margin-bottom: 2rem;
            text-align: center;
        }

        .api-setup h3 {
            margin-bottom: 1rem;
            color: #a78bfa;
        }

        .api-setup input {
            width: 100%;
            max-width: 400px;
            padding: 0.75rem;
            margin: 1rem 0;
            border-radius: 0.5rem;
            border: 2px solid rgba(167, 139, 250, 0.3);
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 1rem;
        }

        .api-setup button {
            background: linear-gradient(135deg, #6b4f9e 0%, #8b5cf6 100%);
            color: white;
            border: none;
            padding: 0.75rem 2rem;
            border-radius: 0.5rem;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .api-setup button:hover {
            transform: scale(1.05);
        }

        .scoreboard {
            background: rgba(107, 79, 158, 0.3);
            border-radius: 1rem;
            padding: 1.5rem;
            margin-bottom: 2rem;
            border: 2px solid rgba(167, 139, 250, 0.5);
        }

        .scoreboard-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1.5rem;
        }

        .stats {
            display: flex;
            gap: 2rem;
        }

        .stat {
            text-align: center;
        }

        .stat-value {
            font-size: 2.5rem;
            font-weight: bold;
            color: #a78bfa;
        }

        .stat-label {
            color: #d4c5f9;
            margin-top: 0.25rem;
            font-size: 0.9rem;
        }

        .loading {
            text-align: center;
            padding: 3rem;
            font-size: 1.2rem;
            color: #a78bfa;
        }

        .error {
            background: rgba(239, 68, 68, 0.2);
            border: 2px solid rgba(239, 68, 68, 0.5);
            color: #fecaca;
            padding: 1rem;
            border-radius: 0.5rem;
            margin-bottom: 1rem;
        }

        .games-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(min(100%, 500px), 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .game-card {
            border-radius: 1rem;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            transition: transform 0.2s;
        }

        .game-card:hover {
            transform: translateY(-5px);
        }

        .game-header {
            padding: 1.5rem;
            color: white;
        }

        .game-meta {
            display: flex;
            gap: 0.75rem;
            margin-bottom: 1rem;
            flex-wrap: wrap;
        }

        .badge {
            background: rgba(255, 255, 255, 0.2);
            padding: 0.35rem 0.75rem;
            border-radius: 1rem;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .confidence-high {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        }

        .confidence-medium {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        }

        .confidence-low {
            background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%);
        }

        .teams {
            display: flex;
            justify-content: space-around;
            align-items: center;
            gap: 1rem;
        }

        .team {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .team-logo {
            width: 50px;
            height: 50px;
            object-fit: contain;
        }

        .team-name {
            font-size: 1.1rem;
            font-weight: bold;
        }

        .team-record {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .team-rankings {
            font-size: 0.8rem;
            opacity: 0.8;
        }

        .vs {
            font-size: 1.5rem;
            font-weight: bold;
            opacity: 0.5;
        }

        .game-body {
            background: rgba(0, 0, 0, 0.3);
            padding: 1.5rem;
        }

        .winner-section {
            text-align: center;
            margin-bottom: 1.5rem;
        }

        .winner-label {
            font-size: 0.9rem;
            color: #a78bfa;
            margin-bottom: 0.5rem;
        }

        .winner-name {
            font-size: 1.8rem;
            font-weight: bold;
            margin-bottom: 0.5rem;
        }

        .confidence {
            font-size: 0.9rem;
            opacity: 0.8;
        }

        .rationale {
            margin-top: 1rem;
            background: rgba(255, 255, 255, 0.05);
            padding: 1rem;
            border-radius: 0.5rem;
        }

        .rationale-item {
            padding: 0.25rem 0;
            font-size: 0.9rem;
        }

        .prediction-section {
            margin-top: 1.5rem;
        }

        .prediction-title {
            font-weight: bold;
            margin-bottom: 0.75rem;
            color: #a78bfa;
        }

        .prediction-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
        }

        .pred-stat {
            background: rgba(255, 255, 255, 0.05);
            padding: 1rem;
            border-radius: 0.5rem;
            text-align: center;
        }

        .pred-label {
            font-size: 0.9rem;
            opacity: 0.8;
            margin-bottom: 0.5rem;
        }

        .pred-value {
            font-size: 2rem;
            font-weight: bold;
            color: #a78bfa;
        }

        .stats-breakdown {
            background: rgba(255, 255, 255, 0.05);
            padding: 1rem;
            border-radius: 0.5rem;
        }

        .stat-row {
            display: flex;
            justify-content: space-between;
            padding: 0.5rem 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .stat-row:last-child {
            border-bottom: none;
        }

        .matchup-edge {
            background: rgba(167, 139, 250, 0.1);
            padding: 0.75rem;
            border-radius: 0.5rem;
            margin-bottom: 0.5rem;
        }

        .edge-item {
            font-size: 0.9rem;
        }

        .injuries {
            margin-top: 0.5rem;
        }

        .injury-item {
            font-size: 0.85rem;
            padding: 0.25rem 0;
        }

        .back-to-top {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, #6b4f9e 0%, #8b5cf6 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            transition: transform 0.2s;
        }

        .back-to-top::before {
            content: '‚Üë';
            font-size: 1.5rem;
            color: white;
        }

        .back-to-top:hover {
            transform: scale(1.1);
        }

        @media (max-width: 768px) {
            .teams {
                flex-direction: column;
            }

            .stats {
                gap: 1rem;
            }

            .stat-value {
                font-size: 2rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üèà NFL PREDICTIONS</h1>
            <div class="week-indicator" id="weekIndicator">Loading...</div>
            <p class="subtitle">Advanced Matchup Analysis ‚Ä¢ Injury Reports ‚Ä¢ Expert Metrics</p>
        </header>

        <div class="api-setup" id="apiSetup">
            <h3>üîë The Odds API Key (Required)</h3>
            <p style="color: #d4c5f9;">
                Get your free API key from <a href="https://the-odds-api.com/" target="_blank" style="color: #a78bfa;">the-odds-api.com</a>
            </p>
            <input type="text" id="apiKeyInput" placeholder="Enter your API key here" />
            <button onclick="saveApiKey()">Save & Load Predictions</button>
        </div>

        <div class="scoreboard">
            <div class="scoreboard-content">
                <div>
                    <h2>üìà Prediction Accuracy</h2>
                    <p style="color: #f3f0ff;">Season Performance</p>
                </div>
                <div class="stats">
                    <div class="stat">
                        <div class="stat-value" id="correct">0</div>
                        <div class="stat-label">Correct</div>
                    </div>
                    <div class="stat">
                        <div class="stat-value" id="total">0</div>
                        <div class="stat-label">Total</div>
                    </div>
                    <div class="stat">
                        <div class="stat-value" id="accuracy">0%</div>
                        <div class="stat-label">Accuracy</div>
                    </div>
                </div>
            </div>
        </div>

        <div id="error" class="error" style="display: none;"></div>
        <div id="loading" class="loading">Enter your API key to load predictions...</div>
        <div id="picksummary" class="scoreboard" style="display: none;">
            <h2 style="margin-bottom: 1rem;">üéØ Winner Picks Summary</h2>
            <div id="picks-list" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 0.75rem;"></div>
        </div>
        <div id="games" class="games-grid"></div>
    </div>

    <div class="back-to-top" id="backToTop" onclick="window.scrollTo({top: 0, behavior: 'smooth'})" title="Back to top"></div>

    <script>
        // ===== CONFIGURATION =====
        let apiKey = localStorage.getItem('nfl_odds_api_key') || '';
        let predictions = JSON.parse(localStorage.getItem('nfl_predictions') || '{}');
        let accuracyStats = JSON.parse(localStorage.getItem('nfl_accuracy') || '{"correct": 0, "total": 0}');

        // Team locations for weather
        const TEAM_LOCATIONS = {
            "Arizona Cardinals": { lat: 33.5276, lon: -112.2626, stadium: "State Farm Stadium" },
            "Atlanta Falcons": { lat: 33.7554, lon: -84.4008, stadium: "Mercedes-Benz Stadium" },
            "Baltimore Ravens": { lat: 39.2780, lon: -76.6227, stadium: "M&T Bank Stadium" },
            "Buffalo Bills": { lat: 42.7738, lon: -78.7870, stadium: "Highmark Stadium" },
            "Carolina Panthers": { lat: 35.2258, lon: -80.8530, stadium: "Bank of America Stadium" },
            "Chicago Bears": { lat: 41.8623, lon: -87.6167, stadium: "Soldier Field" },
            "Cincinnati Bengals": { lat: 39.0954, lon: -84.5160, stadium: "Paycor Stadium" },
            "Cleveland Browns": { lat: 41.5061, lon: -81.6995, stadium: "Cleveland Browns Stadium" },
            "Dallas Cowboys": { lat: 32.7473, lon: -97.0945, stadium: "AT&T Stadium" },
            "Denver Broncos": { lat: 39.7439, lon: -105.0201, stadium: "Empower Field" },
            "Detroit Lions": { lat: 42.3400, lon: -83.0456, stadium: "Ford Field" },
            "Green Bay Packers": { lat: 44.5013, lon: -88.0622, stadium: "Lambeau Field" },
            "Houston Texans": { lat: 29.6847, lon: -95.4107, stadium: "NRG Stadium" },
            "Indianapolis Colts": { lat: 39.7601, lon: -86.1639, stadium: "Lucas Oil Stadium" },
            "Jacksonville Jaguars": { lat: 30.3240, lon: -81.6373, stadium: "TIAA Bank Field" },
            "Kansas City Chiefs": { lat: 39.0489, lon: -94.4839, stadium: "GEHA Field at Arrowhead Stadium" },
            "Las Vegas Raiders": { lat: 36.0908, lon: -115.1831, stadium: "Allegiant Stadium" },
            "Los Angeles Chargers": { lat: 33.9535, lon: -118.3390, stadium: "SoFi Stadium" },
            "Los Angeles Rams": { lat: 33.9535, lon: -118.3390, stadium: "SoFi Stadium" },
            "Miami Dolphins": { lat: 25.9580, lon: -80.2389, stadium: "Hard Rock Stadium" },
            "Minnesota Vikings": { lat: 44.9738, lon: -93.2577, stadium: "U.S. Bank Stadium" },
            "New England Patriots": { lat: 42.0909, lon: -71.2643, stadium: "Gillette Stadium" },
            "New Orleans Saints": { lat: 29.9511, lon: -90.0812, stadium: "Caesars Superdome" },
            "New York Giants": { lat: 40.8128, lon: -74.0742, stadium: "MetLife Stadium" },
            "New York Jets": { lat: 40.8128, lon: -74.0742, stadium: "MetLife Stadium" },
            "Philadelphia Eagles": { lat: 39.9008, lon: -75.1675, stadium: "Lincoln Financial Field" },
            "Pittsburgh Steelers": { lat: 40.4468, lon: -80.0158, stadium: "Acrisure Stadium" },
            "San Francisco 49ers": { lat: 37.4032, lon: -121.9697, stadium: "Levi's Stadium" },
            "Seattle Seahawks": { lat: 47.5952, lon: -122.3316, stadium: "Lumen Field" },
            "Tampa Bay Buccaneers": { lat: 27.9759, lon: -82.5033, stadium: "Raymond James Stadium" },
            "Tennessee Titans": { lat: 36.1665, lon: -86.7713, stadium: "Nissan Stadium" },
            "Washington Commanders": { lat: 38.9076, lon: -76.8645, stadium: "FedExField" }
        };

        // Team logos and colors
        const TEAM_DATA = {
            "Arizona Cardinals": { colors: ["#97233F", "#FFB612"], logo: "https://a.espncdn.com/i/teamlogos/nfl/500/ari.png" },
            "Atlanta Falcons": { colors: ["#A71930", "#000000"], logo: "https://a.espncdn.com/i/teamlogos/nfl/500/atl.png" },
            "Baltimore Ravens": { colors: ["#241773", "#000000"], logo: "https://a.espncdn.com/i/teamlogos/nfl/500/bal.png" },
            "Buffalo Bills": { colors: ["#00338D", "#C60C30"], logo: "https://a.espncdn.com/i/teamlogos/nfl/500/buf.png" },
            "Carolina Panthers": { colors: ["#0085CA", "#101820"], logo: "https://a.espncdn.com/i/teamlogos/nfl/500/car.png" },
            "Chicago Bears": { colors: ["#0B162A", "#C83803"], logo: "https://a.espncdn.com/i/teamlogos/nfl/500/chi.png" },
            "Cincinnati Bengals": { colors: ["#FB4F14", "#000000"], logo: "https://a.espncdn.com/i/teamlogos/nfl/500/cin.png" },
            "Cleveland Browns": { colors: ["#311D00", "#FF3C00"], logo: "https://a.espncdn.com/i/teamlogos/nfl/500/cle.png" },
            "Dallas Cowboys": { colors: ["#003594", "#869397"], logo: "https://a.espncdn.com/i/teamlogos/nfl/500/dal.png" },
            "Denver Broncos": { colors: ["#FB4F14", "#002244"], logo: "https://a.espncdn.com/i/teamlogos/nfl/500/den.png" },
            "Detroit Lions": { colors: ["#0076B6", "#B0B7BC"], logo: "https://a.espncdn.com/i/teamlogos/nfl/500/det.png" },
            "Green Bay Packers": { colors: ["#203731", "#FFB612"], logo: "https://a.espncdn.com/i/teamlogos/nfl/500/gb.png" },
            "Houston Texans": { colors: ["#03202F", "#A71930"], logo: "https://a.espncdn.com/i/teamlogos/nfl/500/hou.png" },
            "Indianapolis Colts": { colors: ["#002C5F", "#A2AAAD"], logo: "https://a.espncdn.com/i/teamlogos/nfl/500/ind.png" },
            "Jacksonville Jaguars": { colors: ["#006778", "#D7A22A"], logo: "https://a.espncdn.com/i/teamlogos/nfl/500/jax.png" },
            "Kansas City Chiefs": { colors: ["#E31837", "#FFB81C"], logo: "https://a.espncdn.com/i/teamlogos/nfl/500/kc.png" },
            "Las Vegas Raiders": { colors: ["#000000", "#A5ACAF"], logo: "https://a.espncdn.com/i/teamlogos/nfl/500/lv.png" },
            "Los Angeles Chargers": { colors: ["#0080C6", "#FFC20E"], logo: "https://a.espncdn.com/i/teamlogos/nfl/500/lac.png" },
            "Los Angeles Rams": { colors: ["#003594", "#FFA300"], logo: "https://a.espncdn.com/i/teamlogos/nfl/500/lar.png" },
            "Miami Dolphins": { colors: ["#008E97", "#FC4C02"], logo: "https://a.espncdn.com/i/teamlogos/nfl/500/mia.png" },
            "Minnesota Vikings": { colors: ["#4F2683", "#FFC62F"], logo: "https://a.espncdn.com/i/teamlogos/nfl/500/min.png" },
            "New England Patriots": { colors: ["#002244", "#C60C30"], logo: "https://a.espncdn.com/i/teamlogos/nfl/500/ne.png" },
            "New Orleans Saints": { colors: ["#D3BC8D", "#101820"], logo: "https://a.espncdn.com/i/teamlogos/nfl/500/no.png" },
            "New York Giants": { colors: ["#0B2265", "#A71930"], logo: "https://a.espncdn.com/i/teamlogos/nfl/500/nyg.png" },
            "New York Jets": { colors: ["#125740", "#000000"], logo: "https://a.espncdn.com/i/teamlogos/nfl/500/nyj.png" },
            "Philadelphia Eagles": { colors: ["#004C54", "#A5ACAF"], logo: "https://a.espncdn.com/i/teamlogos/nfl/500/phi.png" },
            "Pittsburgh Steelers": { colors: ["#FFB612", "#101820"], logo: "https://a.espncdn.com/i/teamlogos/nfl/500/pit.png" },
            "San Francisco 49ers": { colors: ["#AA0000", "#B3995D"], logo: "https://a.espncdn.com/i/teamlogos/nfl/500/sf.png" },
            "Seattle Seahawks": { colors: ["#002244", "#69BE28"], logo: "https://a.espncdn.com/i/teamlogos/nfl/500/sea.png" },
            "Tampa Bay Buccaneers": { colors: ["#D50A0A", "#FF7900"], logo: "https://a.espncdn.com/i/teamlogos/nfl/500/tb.png" },
            "Tennessee Titans": { colors: ["#0C2340", "#4B92DB"], logo: "https://a.espncdn.com/i/teamlogos/nfl/500/ten.png" },
            "Washington Commanders": { colors: ["#5A1414", "#FFB612"], logo: "https://a.espncdn.com/i/teamlogos/nfl/500/wsh.png" }
        };

        // ===== INITIALIZATION =====
        if (apiKey) {
            document.getElementById('apiKeyInput').value = apiKey;
            document.getElementById('apiSetup').style.display = 'none';
            loadAllData();
        }

        updateAccuracyDisplay();

        function saveApiKey() {
            const input = document.getElementById('apiKeyInput');
            apiKey = input.value.trim();
            if (apiKey) {
                localStorage.setItem('nfl_odds_api_key', apiKey);
                document.getElementById('apiSetup').style.display = 'none';
                loadAllData();
            } else {
                showError('Please enter a valid API key');
            }
        }

        function showError(message) {
            const errorEl = document.getElementById('error');
            errorEl.textContent = message;
            errorEl.style.display = 'block';
            setTimeout(() => errorEl.style.display = 'none', 10000);
        }

        function updateAccuracyDisplay() {
            document.getElementById('correct').textContent = accuracyStats.correct;
            document.getElementById('total').textContent = accuracyStats.total;
            const accuracy = accuracyStats.total > 0 ? ((accuracyStats.correct / accuracyStats.total) * 100).toFixed(1) : 0;
            document.getElementById('accuracy').textContent = accuracy + '%';
        }

        // ===== MAIN DATA LOADING =====
        async function loadAllData() {
            try {
                document.getElementById('loading').textContent = 'üèà Loading NFL data...';

                // Fetch upcoming games from ESPN
                const games = await fetchGames();

                if (games.length === 0) {
                    document.getElementById('loading').textContent = 'No upcoming games in the next 7 days';
                    return;
                }

                // Fetch odds data
                let oddsData = [];
                try {
                    oddsData = await fetchOdds();
                } catch (e) {
                    console.warn('Could not fetch odds:', e.message);
                }

                // Check past predictions
                await checkPredictionResults();
                updateAccuracyDisplay();

                // Display games
                await displayGames(games, oddsData);

                document.getElementById('loading').style.display = 'none';
            } catch (error) {
                console.error('Error loading data:', error);
                showError('Failed to load data: ' + error.message);
                document.getElementById('loading').textContent = 'Error loading data. Check console.';
            }
        }

        // ===== FETCH GAMES FROM ESPN =====
        async function fetchGames() {
            console.log('üì• Fetching games from ESPN...');

            const games = [];
            const now = new Date();
            const sevenDaysFromNow = new Date(now.getTime() + 7 * 24 * 60 * 60 * 1000);

            // Fetch current week's scoreboard
            const response = await fetch('https://site.api.espn.com/apis/site/v2/sports/football/nfl/scoreboard');
            const data = await response.json();

            if (data.week && data.week.number) {
                document.getElementById('weekIndicator').textContent = `Week ${data.week.number}`;
            }

            // Filter for upcoming games
            for (const event of data.events || []) {
                const gameDate = new Date(event.date);

                if (gameDate > now && gameDate < sevenDaysFromNow) {
                    games.push(event);
                }
            }

            console.log(`‚úÖ Found ${games.length} upcoming games`);
            return games;
        }

        // ===== FETCH ODDS =====
        async function fetchOdds() {
            if (!apiKey) return [];

            console.log('üí∞ Fetching odds...');
            const response = await fetch(`https://api.the-odds-api.com/v4/sports/americanfootball_nfl/odds/?apiKey=${apiKey}&regions=us&markets=spreads,totals,h2h`);

            if (!response.ok) {
                throw new Error('Failed to fetch odds');
            }

            const data = await response.json();
            console.log(`‚úÖ Fetched odds for ${data.length} games`);
            return data;
        }

        // ===== FETCH WEATHER =====
        async function fetchWeather(homeTeam, gameDate) {
            const location = TEAM_LOCATIONS[homeTeam];
            if (!location) return null;

            try {
                const date = new Date(gameDate);
                const dateStr = date.toISOString().split('T')[0];

                const url = `https://api.open-meteo.com/v1/forecast?latitude=${location.lat}&longitude=${location.lon}&hourly=temperature_2m,precipitation_probability,windspeed_10m,weathercode&temperature_unit=fahrenheit&windspeed_unit=mph&timezone=America/New_York&start_date=${dateStr}&end_date=${dateStr}`;

                const response = await fetch(url);
                const data = await response.json();

                const hour = date.getHours();
                const temp = data.hourly.temperature_2m[hour] || 70;
                const precip = data.hourly.precipitation_probability[hour] || 0;
                const wind = data.hourly.windspeed_10m[hour] || 0;
                const code = data.hourly.weathercode[hour] || 0;

                let condition = 'Clear';
                if (code >= 71 && code <= 77) condition = 'Snow';
                else if (code >= 61 && code <= 67) condition = 'Rain';
                else if (code >= 51 && code <= 57) condition = 'Drizzle';
                else if (code >= 80 && code <= 99) condition = 'Heavy Rain';
                else if (code >= 45 && code <= 48) condition = 'Fog';

                return {
                    temp: Math.round(temp),
                    precipitation: precip,
                    windSpeed: Math.round(wind),
                    condition: condition,
                    rain: condition.includes('Rain') ? 1 : 0,
                    snow: condition === 'Snow' ? 1 : 0
                };
            } catch (error) {
                console.warn('Weather fetch failed:', error.message);
                return null;
            }
        }

        // ===== GENERATE PREDICTION =====
        function generatePrediction(game, odds, weather) {
            const competition = game.competitions[0];
            const homeComp = competition.competitors.find(c => c.homeAway === 'home');
            const awayComp = competition.competitors.find(c => c.homeAway === 'away');

            const homeTeam = homeComp.team.displayName;
            const awayTeam = awayComp.team.displayName;

            // Get team records and stats
            const homeRecord = homeComp.records?.[0]?.summary || '0-0';
            const awayRecord = awayComp.records?.[0]?.summary || '0-0';

            const homeStats = homeComp.statistics || [];
            const awayStats = awayComp.statistics || [];

            // Extract stats if available
            const homePPG = parseFloat(homeStats.find(s => s.name === 'avgPointsFor')?.displayValue || 22);
            const awayPPG = parseFloat(awayStats.find(s => s.name === 'avgPointsFor')?.displayValue || 22);
            const homePAPG = parseFloat(homeStats.find(s => s.name === 'avgPointsAgainst')?.displayValue || 22);
            const awayPAPG = parseFloat(awayStats.find(s => s.name === 'avgPointsAgainst')?.displayValue || 22);

            // Calculate win percentages
            const [homeWins, homeLosses] = homeRecord.split('-').map(n => parseInt(n) || 0);
            const [awayWins, awayLosses] = awayRecord.split('-').map(n => parseInt(n) || 0);
            const homeWinPct = (homeWins + homeLosses) > 0 ? homeWins / (homeWins + homeLosses) : 0.5;
            const awayWinPct = (awayWins + awayLosses) > 0 ? awayWins / (awayWins + awayLosses) : 0.5;

            let prediction = {
                homeTeam,
                awayTeam,
                homeRecord,
                awayRecord,
                spread: 'N/A',
                total: 'N/A',
                homeMoneyline: 'N/A',
                awayMoneyline: 'N/A',
                weather: weather,
                rationale: [],
                edges: []
            };

            // Parse odds if available
            if (odds) {
                const spreadsMarket = odds.bookmakers?.[0]?.markets?.find(m => m.key === 'spreads');
                const totalsMarket = odds.bookmakers?.[0]?.markets?.find(m => m.key === 'totals');
                const h2hMarket = odds.bookmakers?.[0]?.markets?.find(m => m.key === 'h2h');

                if (spreadsMarket) {
                    const homeSpread = spreadsMarket.outcomes.find(o => o.name === homeTeam);
                    prediction.spread = homeSpread?.point || 'N/A';
                }
                if (totalsMarket) {
                    prediction.total = totalsMarket.outcomes[0]?.point || 'N/A';
                }
                if (h2hMarket) {
                    const homeML = h2hMarket.outcomes.find(o => o.name === homeTeam);
                    const awayML = h2hMarket.outcomes.find(o => o.name === awayTeam);
                    prediction.homeMoneyline = homeML?.price || 'N/A';
                    prediction.awayMoneyline = awayML?.price || 'N/A';
                }
            }

            // Calculate predicted scores
            let baseHomeScore = (homePPG + awayPAPG) / 2;
            let baseAwayScore = (awayPPG + homePAPG) / 2;

            // Adjust for odds if available
            if (prediction.spread !== 'N/A' && prediction.total !== 'N/A') {
                const spread = parseFloat(prediction.spread);
                const total = parseFloat(prediction.total);
                const oddsHome = (total - spread) / 2;
                const oddsAway = (total + spread) / 2;

                baseHomeScore = baseHomeScore * 0.4 + oddsHome * 0.6;
                baseAwayScore = baseAwayScore * 0.4 + oddsAway * 0.6;
            }

            // Home field advantage
            baseHomeScore += 2.5;

            // Win percentage adjustment
            baseHomeScore += (homeWinPct - 0.5) * 3;
            baseAwayScore += (awayWinPct - 0.5) * 3;

            // Weather adjustments
            if (weather && (weather.rain || weather.snow)) {
                const impact = weather.snow ? 6 : 3;
                baseHomeScore -= impact * 0.5;
                baseAwayScore -= impact * 0.5;
                prediction.edges.push(`${weather.condition} conditions expected - lower scoring game likely`);
            }

            if (weather && weather.windSpeed > 20) {
                baseHomeScore -= 3;
                baseAwayScore -= 3;
                prediction.edges.push(`High winds (${weather.windSpeed}mph) - passing game impacted`);
            }

            // Finalize scores
            prediction.homeScore = Math.max(10, Math.round(baseHomeScore));
            prediction.awayScore = Math.max(10, Math.round(baseAwayScore));

            // Prevent ties
            if (prediction.homeScore === prediction.awayScore) {
                prediction.homeScore += 1;
            }

            prediction.winner = prediction.homeScore > prediction.awayScore ? homeTeam : awayTeam;
            const margin = Math.abs(prediction.homeScore - prediction.awayScore);

            // Build rationale
            prediction.rationale.push(`${prediction.winner} favored by ${margin} points`);

            if (prediction.spread !== 'N/A') {
                const spreadFav = parseFloat(prediction.spread) < 0 ? homeTeam : awayTeam;
                prediction.rationale.push(`Vegas favors ${spreadFav} (${Math.abs(parseFloat(prediction.spread))} pts)`);
            }

            if (prediction.winner === homeTeam) {
                prediction.rationale.push('Home field advantage');
            }

            const winnerWinPct = prediction.winner === homeTeam ? homeWinPct : awayWinPct;
            if (winnerWinPct > 0.6) {
                prediction.rationale.push(`${prediction.winner} has strong ${(winnerWinPct * 100).toFixed(0)}% win rate`);
            }

            // Confidence
            let confidenceScore = margin;
            if (prediction.spread !== 'N/A' && Math.abs(parseFloat(prediction.spread)) > 7) confidenceScore += 3;
            if (winnerWinPct > 0.7) confidenceScore += 4;

            if (confidenceScore >= 10) prediction.confidence = 'High';
            else if (confidenceScore >= 5) prediction.confidence = 'Medium';
            else prediction.confidence = 'Low';

            // Spread bet
            if (prediction.spread !== 'N/A') {
                const actualMargin = prediction.homeScore - prediction.awayScore;
                prediction.beatsSpread = actualMargin > parseFloat(prediction.spread) ? 'Yes' : 'No';
            } else {
                prediction.beatsSpread = 'N/A';
            }

            return prediction;
        }

        // ===== DISPLAY GAMES =====
        async function displayGames(games, oddsData) {
            const gamesContainer = document.getElementById('games');
            const picksList = document.getElementById('picks-list');
            const picksSummary = document.getElementById('picksummary');

            gamesContainer.innerHTML = '';
            picksList.innerHTML = '';

            if (games.length === 0) {
                gamesContainer.innerHTML = '<div style="text-align: center; padding: 3rem;">No upcoming games</div>';
                return;
            }

            // Generate predictions for all games
            const gamesWithPredictions = [];

            for (const game of games) {
                const competition = game.competitions[0];
                const homeComp = competition.competitors.find(c => c.homeAway === 'home');
                const homeTeam = homeComp.team.displayName;

                // Find matching odds
                const gameOdds = oddsData.find(o =>
                    o.home_team === homeTeam ||
                    (o.home_team.includes(homeTeam.split(' ').pop()) && o.commence_time &&
                     Math.abs(new Date(o.commence_time) - new Date(game.date)) < 3600000)
                );

                // Fetch weather
                const weather = await fetchWeather(homeTeam, game.date);

                // Generate prediction
                const prediction = generatePrediction(game, gameOdds, weather);

                // Save prediction
                const gameId = game.id;
                savePrediction(gameId, game.date, prediction);

                gamesWithPredictions.push({ game, prediction, gameId });
            }

            // Sort by confidence
            const confidenceOrder = { 'High': 0, 'Medium': 1, 'Low': 2 };
            gamesWithPredictions.sort((a, b) => {
                const dateA = new Date(a.game.date);
                const dateB = new Date(b.game.date);
                if (dateA.toDateString() !== dateB.toDateString()) {
                    return dateA - dateB;
                }
                return confidenceOrder[a.prediction.confidence] - confidenceOrder[b.prediction.confidence];
            });

            // Create picks summary
            gamesWithPredictions.forEach(({ prediction, gameId }) => {
                const teamColor = TEAM_DATA[prediction.winner]?.colors[0] || '#6b4f9e';
                const loser = prediction.winner === prediction.homeTeam ? prediction.awayTeam : prediction.homeTeam;

                picksList.innerHTML += `
                    <div onclick="document.getElementById('${gameId}').scrollIntoView({behavior: 'smooth', block: 'center'})"
                         style="background: rgba(255,255,255,0.1); padding: 0.75rem; border-radius: 0.5rem; cursor: pointer; border-left: 4px solid ${teamColor}; transition: all 0.2s;"
                         onmouseover="this.style.background='rgba(255,255,255,0.2)'"
                         onmouseout="this.style.background='rgba(255,255,255,0.1)'">
                        <div style="font-weight: bold; font-size: 1.1rem;">${prediction.winner}</div>
                        <div style="font-size: 0.85rem; opacity: 0.9;">over ${loser}</div>
                        <div style="font-size: 0.75rem; opacity: 0.8; margin-top: 0.25rem;">
                            ${prediction.homeScore}-${prediction.awayScore} ‚Ä¢ ${prediction.confidence}
                        </div>
                    </div>
                `;
            });
            picksSummary.style.display = 'block';

            // Display game cards
            gamesWithPredictions.forEach(({ game, prediction, gameId }) => {
                gamesContainer.innerHTML += createGameCard(game, prediction, gameId);
            });
        }

        // ===== CREATE GAME CARD =====
        function createGameCard(game, prediction, gameId) {
            const teamColor = TEAM_DATA[prediction.homeTeam]?.colors[0] || '#6b4f9e';
            const homeLogo = TEAM_DATA[prediction.homeTeam]?.logo;
            const awayLogo = TEAM_DATA[prediction.awayTeam]?.logo;

            const gameDate = new Date(game.date);
            const gameTime = gameDate.toLocaleDateString('en-US', {
                weekday: 'short',
                month: 'short',
                day: 'numeric',
                hour: 'numeric',
                minute: '2-digit'
            });

            const confidenceClass = `confidence-${prediction.confidence.toLowerCase()}`;

            // Weather HTML
            let weatherHTML = '';
            if (prediction.weather) {
                const w = prediction.weather;
                let weatherIcon = '‚òÄÔ∏è';
                if (w.condition === 'Snow') weatherIcon = '‚ùÑÔ∏è';
                else if (w.condition.includes('Rain')) weatherIcon = 'üåßÔ∏è';
                else if (w.condition === 'Fog') weatherIcon = 'üå´Ô∏è';

                weatherHTML = `<div class="badge" style="background: rgba(255,255,255,0.3);">${weatherIcon} ${w.temp}¬∞F ${w.condition}${w.windSpeed > 15 ? ` ‚Ä¢ ${w.windSpeed}mph` : ''}</div>`;
            }

            // Rationale HTML
            let rationaleHTML = '';
            if (prediction.rationale.length > 0) {
                rationaleHTML = '<div class="rationale">';
                prediction.rationale.forEach(reason => {
                    rationaleHTML += `<div class="rationale-item">‚úì ${reason}</div>`;
                });
                rationaleHTML += '</div>';
            }

            // Edges HTML
            let edgesHTML = '';
            if (prediction.edges.length > 0) {
                edgesHTML = '<div class="prediction-section"><div class="prediction-title">‚ö° Key Edges</div>';
                prediction.edges.forEach(edge => {
                    edgesHTML += `<div class="matchup-edge"><div class="edge-item">‚úì ${edge}</div></div>`;
                });
                edgesHTML += '</div>';
            }

            return `
                <div id="${gameId}" class="game-card" style="background: linear-gradient(135deg, ${teamColor}22 0%, ${teamColor}44 100%); border: 2px solid ${teamColor}88;">
                    <div class="game-header" style="background-color: ${teamColor}ee;">
                        <div class="game-meta">
                            <div class="badge">üìÖ ${gameTime}</div>
                            ${weatherHTML}
                            <div class="badge ${confidenceClass}">${prediction.confidence.toUpperCase()}</div>
                        </div>
                        <div class="teams">
                            <div class="team">
                                ${awayLogo ? `<img src="${awayLogo}" alt="${prediction.awayTeam}" class="team-logo">` : ''}
                                <div>
                                    <div class="team-name">${prediction.awayTeam}</div>
                                    <div class="team-record">${prediction.awayRecord}</div>
                                </div>
                            </div>
                            <div class="vs">@</div>
                            <div class="team">
                                <div style="text-align: right;">
                                    <div class="team-name">${prediction.homeTeam}</div>
                                    <div class="team-record">${prediction.homeRecord}</div>
                                </div>
                                ${homeLogo ? `<img src="${homeLogo}" alt="${prediction.homeTeam}" class="team-logo">` : ''}
                            </div>
                        </div>
                    </div>
                    <div class="game-body">
                        <div class="winner-section">
                            <div class="winner-label">üéØ PREDICTED WINNER</div>
                            <div class="winner-name">${prediction.winner}</div>
                            <div class="confidence">Confidence: ${prediction.confidence}</div>
                            ${rationaleHTML}
                        </div>

                        ${edgesHTML}

                        <div class="prediction-section">
                            <div class="prediction-title">üìä Score Prediction</div>
                            <div class="prediction-grid">
                                <div class="pred-stat">
                                    <div class="pred-label">${prediction.homeTeam}</div>
                                    <div class="pred-value">${prediction.homeScore}</div>
                                </div>
                                <div class="pred-stat">
                                    <div class="pred-label">${prediction.awayTeam}</div>
                                    <div class="pred-value">${prediction.awayScore}</div>
                                </div>
                            </div>
                        </div>

                        <div class="prediction-section">
                            <div class="prediction-title">üí∞ Betting Lines</div>
                            <div class="stats-breakdown">
                                <div class="stat-row">
                                    <span>Spread:</span>
                                    <strong>${prediction.homeTeam} ${prediction.spread}</strong>
                                </div>
                                <div class="stat-row">
                                    <span>Over/Under:</span>
                                    <strong>${prediction.total}</strong>
                                </div>
                                <div class="stat-row">
                                    <span>Beats Spread:</span>
                                    <strong>${prediction.beatsSpread}</strong>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // ===== PREDICTION TRACKING =====
        function savePrediction(gameId, gameDate, prediction) {
            const gameTime = new Date(gameDate);
            const now = new Date();

            // Only save if game hasn't started
            if (now < gameTime) {
                predictions[gameId] = {
                    date: gameDate,
                    prediction: {
                        winner: prediction.winner,
                        homeTeam: prediction.homeTeam,
                        awayTeam: prediction.awayTeam,
                        homeScore: prediction.homeScore,
                        awayScore: prediction.awayScore
                    }
                };
                localStorage.setItem('nfl_predictions', JSON.stringify(predictions));
            }
        }

        async function checkPredictionResults() {
            const now = new Date();
            const fourHoursAgo = new Date(now.getTime() - 4 * 60 * 60 * 1000);

            for (const gameId in predictions) {
                const pred = predictions[gameId];
                const gameDate = new Date(pred.date);

                // Check games that finished 4+ hours ago
                if (gameDate < fourHoursAgo && !pred.checked) {
                    try {
                        const response = await fetch(`https://site.api.espn.com/apis/site/v2/sports/football/nfl/summary?event=${gameId}`);
                        const data = await response.json();

                        const competition = data.boxscore?.teams;
                        if (competition && competition.length === 2) {
                            const homeTeam = competition.find(t => t.homeAway === 'home');
                            const awayTeam = competition.find(t => t.homeAway === 'away');

                            const homeScore = parseInt(homeTeam.statistics.find(s => s.name === 'points')?.displayValue || 0);
                            const awayScore = parseInt(awayTeam.statistics.find(s => s.name === 'points')?.displayValue || 0);

                            const actualWinner = homeScore > awayScore ? homeTeam.team.displayName : awayTeam.team.displayName;
                            const predictedWinner = pred.prediction.winner;

                            if (actualWinner === predictedWinner) {
                                accuracyStats.correct++;
                            }
                            accuracyStats.total++;

                            pred.checked = true;
                            predictions[gameId] = pred;
                        }
                    } catch (e) {
                        console.warn(`Could not check result for game ${gameId}`);
                    }
                }
            }

            localStorage.setItem('nfl_predictions', JSON.stringify(predictions));
            localStorage.setItem('nfl_accuracy', JSON.stringify(accuracyStats));
        }
    </script>
</body>
</html>
