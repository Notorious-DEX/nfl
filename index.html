<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BRObet - NFL Predictions</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            min-height: 100vh;
            padding: 1rem;
            color: white;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            margin-bottom: 2rem;
        }

        h1 {
            font-size: clamp(2rem, 5vw, 3.5rem);
            margin-bottom: 0.5rem;
            background: linear-gradient(135deg, #f39c12, #e74c3c);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-weight: 900;
        }

        .tagline {
            color: #95a5a6;
            font-size: clamp(0.9rem, 2vw, 1.1rem);
            font-weight: 500;
        }

        .week-indicator {
            font-size: clamp(1rem, 3vw, 1.5rem);
            color: #3498db;
            font-weight: bold;
            margin: 0.5rem 0;
        }

        .api-setup {
            background: rgba(52, 152, 219, 0.1);
            border: 2px solid rgba(52, 152, 219, 0.3);
            border-radius: 1rem;
            padding: 2rem;
            margin-bottom: 2rem;
            text-align: center;
        }

        .api-setup h3 {
            margin-bottom: 1rem;
            color: #3498db;
        }

        .api-setup input {
            width: 100%;
            max-width: 400px;
            padding: 0.75rem;
            margin: 1rem 0;
            border-radius: 0.5rem;
            border: 2px solid rgba(52, 152, 219, 0.3);
            background: rgba(255, 255, 255, 0.05);
            color: white;
            font-size: 1rem;
        }

        .api-setup button {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            color: white;
            border: none;
            padding: 0.75rem 2rem;
            border-radius: 0.5rem;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .api-setup button:hover {
            transform: scale(1.05);
        }

        .scoreboard {
            background: rgba(52, 152, 219, 0.1);
            border-radius: 1rem;
            padding: 1.5rem;
            margin-bottom: 2rem;
            border: 2px solid rgba(52, 152, 219, 0.3);
        }

        .scoreboard-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1.5rem;
        }

        .stats {
            display: flex;
            gap: 2rem;
        }

        .stat {
            text-align: center;
        }

        .stat-value {
            font-size: 2.5rem;
            font-weight: bold;
            color: #e74c3c;
        }

        .stat-label {
            color: #95a5a6;
            margin-top: 0.25rem;
            font-size: 0.9rem;
        }

        .loading {
            text-align: center;
            padding: 3rem;
            font-size: 1.2rem;
            color: #3498db;
        }

        .error {
            background: rgba(231, 76, 60, 0.2);
            border: 2px solid rgba(231, 76, 60, 0.5);
            color: #e74c3c;
            padding: 1rem;
            border-radius: 0.5rem;
            margin-bottom: 1rem;
        }

        .games-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(min(100%, 500px), 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .game-card {
            border-radius: 1rem;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            transition: transform 0.2s;
        }

        .game-card:hover {
            transform: translateY(-5px);
        }

        .game-header {
            padding: 1.5rem;
            color: white;
        }

        .game-meta {
            display: flex;
            gap: 0.75rem;
            margin-bottom: 1rem;
            flex-wrap: wrap;
        }

        .badge {
            background: rgba(255, 255, 255, 0.2);
            padding: 0.35rem 0.75rem;
            border-radius: 1rem;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .confidence-high {
            background: linear-gradient(135deg, #27ae60 0%, #229954 100%);
        }

        .confidence-medium {
            background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
        }

        .confidence-low {
            background: linear-gradient(135deg, #95a5a6 0%, #7f8c8d 100%);
        }

        .teams {
            display: flex;
            justify-content: space-around;
            align-items: center;
            gap: 1rem;
        }

        .team {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .team-logo {
            width: 50px;
            height: 50px;
            object-fit: contain;
        }

        .team-name {
            font-size: 1.1rem;
            font-weight: bold;
        }

        .team-record {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .vs {
            font-size: 1.5rem;
            font-weight: bold;
            opacity: 0.5;
        }

        .game-body {
            background: rgba(0, 0, 0, 0.4);
            padding: 1.5rem;
        }

        .winner-section {
            text-align: center;
            margin-bottom: 1.5rem;
        }

        .winner-label {
            font-size: 0.9rem;
            color: #3498db;
            margin-bottom: 0.5rem;
        }

        .winner-name {
            font-size: 1.8rem;
            font-weight: bold;
            margin-bottom: 0.5rem;
        }

        .confidence {
            font-size: 0.9rem;
            opacity: 0.8;
        }

        .rationale {
            margin-top: 1rem;
            background: rgba(255, 255, 255, 0.05);
            padding: 1rem;
            border-radius: 0.5rem;
            text-align: left;
        }

        .rationale-item {
            padding: 0.25rem 0;
            font-size: 0.9rem;
        }

        .prediction-section {
            margin-top: 1.5rem;
        }

        .prediction-title {
            font-weight: bold;
            margin-bottom: 0.75rem;
            color: #3498db;
        }

        .prediction-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
        }

        .pred-stat {
            background: rgba(255, 255, 255, 0.05);
            padding: 1rem;
            border-radius: 0.5rem;
            text-align: center;
        }

        .pred-label {
            font-size: 0.9rem;
            opacity: 0.8;
            margin-bottom: 0.5rem;
        }

        .pred-value {
            font-size: 2rem;
            font-weight: bold;
            color: #e74c3c;
        }

        .stats-breakdown {
            background: rgba(255, 255, 255, 0.05);
            padding: 1rem;
            border-radius: 0.5rem;
        }

        .stat-row {
            display: flex;
            justify-content: space-between;
            padding: 0.5rem 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .stat-row:last-child {
            border-bottom: none;
        }

        .matchup-edge {
            background: rgba(231, 76, 60, 0.2);
            padding: 0.75rem;
            border-radius: 0.5rem;
            margin-bottom: 0.5rem;
            border-left: 3px solid #e74c3c;
        }

        .edge-item {
            font-size: 0.9rem;
        }

        .footer {
            text-align: center;
            padding: 2rem 1rem;
            margin-top: 3rem;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            color: #95a5a6;
            font-size: 0.85rem;
            line-height: 1.6;
        }

        .footer-brand {
            font-weight: bold;
            color: #e74c3c;
            font-size: 1.1rem;
            margin-bottom: 0.5rem;
        }

        .disclaimer {
            max-width: 800px;
            margin: 1rem auto 0;
            font-size: 0.75rem;
            opacity: 0.7;
        }

        @media (max-width: 768px) {
            .teams {
                flex-direction: column;
            }

            .stats {
                gap: 1rem;
            }

            .stat-value {
                font-size: 2rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üèà BRObet</h1>
            <p class="tagline">Advanced NFL Predictions & Matchup Analysis</p>
            <div class="week-indicator" id="weekIndicator">Loading...</div>
        </header>

        <div class="api-setup" id="apiSetup">
            <h3>üîë The Odds API Key Required</h3>
            <p style="color: #95a5a6;">
                Get your free API key from <a href="https://the-odds-api.com/" target="_blank" style="color: #3498db;">the-odds-api.com</a>
            </p>
            <input type="text" id="apiKeyInput" placeholder="Enter your API key here" />
            <button onclick="saveApiKey()">Save & Load Predictions</button>
        </div>

        <div class="scoreboard">
            <div class="scoreboard-content">
                <div>
                    <h2>üìà Prediction Accuracy</h2>
                    <p style="color: #95a5a6;">Season Performance</p>
                </div>
                <div class="stats">
                    <div class="stat">
                        <div class="stat-value" id="correct">0</div>
                        <div class="stat-label">Correct</div>
                    </div>
                    <div class="stat">
                        <div class="stat-value" id="total">0</div>
                        <div class="stat-label">Total</div>
                    </div>
                    <div class="stat">
                        <div class="stat-value" id="accuracy">0%</div>
                        <div class="stat-label">Accuracy</div>
                    </div>
                </div>
            </div>
        </div>

        <div id="error" class="error" style="display: none;"></div>
        <div id="loading" class="loading">Enter your API key to load predictions...</div>
        <div id="picksummary" class="scoreboard" style="display: none;">
            <h2 style="margin-bottom: 1rem;">üéØ Top Picks</h2>
            <div id="picks-list" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 0.75rem;"></div>
        </div>
        <div id="games" class="games-grid"></div>

        <footer class="footer">
            <div class="footer-brand">BRObet</div>
            <div>¬© 2025 BRObet. All rights reserved.</div>
            <div class="disclaimer">
                <strong>DISCLAIMER:</strong> This website is for informational and entertainment purposes only.
                BRObet provides NFL game predictions and analysis based on statistical models and publicly available data.
                No guarantees are made regarding the accuracy of predictions. Sports betting involves risk, and you should never
                wager more than you can afford to lose. We are not responsible for any losses incurred through the use of
                information provided on this site. Users assume all risk and liability for their betting decisions.
                This site does not operate as a gambling service and does not accept wagers. Please gamble responsibly and
                consult local laws regarding sports betting in your jurisdiction. By using this site, you acknowledge and
                agree to these terms.
            </div>
        </footer>
    </div>

    <script>
        // ===== CONFIGURATION =====
        let apiKey = localStorage.getItem('nfl_odds_api_key') || '';
        let predictions = JSON.parse(localStorage.getItem('nfl_predictions') || '{}');
        let accuracyStats = JSON.parse(localStorage.getItem('nfl_accuracy') || '{"correct": 0, "total": 0}');

        // Team data (logos only - all stats fetched dynamically)
        const TEAM_DATA = {
            "Arizona Cardinals": { logo: "https://a.espncdn.com/i/teamlogos/nfl/500/ari.png", color: "#97233F", lat: 33.5276, lon: -112.2626 },
            "Atlanta Falcons": { logo: "https://a.espncdn.com/i/teamlogos/nfl/500/atl.png", color: "#A71930", lat: 33.7554, lon: -84.4008 },
            "Baltimore Ravens": { logo: "https://a.espncdn.com/i/teamlogos/nfl/500/bal.png", color: "#241773", lat: 39.2780, lon: -76.6227 },
            "Buffalo Bills": { logo: "https://a.espncdn.com/i/teamlogos/nfl/500/buf.png", color: "#00338D", lat: 42.7738, lon: -78.7870 },
            "Carolina Panthers": { logo: "https://a.espncdn.com/i/teamlogos/nfl/500/car.png", color: "#0085CA", lat: 35.2258, lon: -80.8530 },
            "Chicago Bears": { logo: "https://a.espncdn.com/i/teamlogos/nfl/500/chi.png", color: "#0B162A", lat: 41.8623, lon: -87.6167 },
            "Cincinnati Bengals": { logo: "https://a.espncdn.com/i/teamlogos/nfl/500/cin.png", color: "#FB4F14", lat: 39.0954, lon: -84.5160 },
            "Cleveland Browns": { logo: "https://a.espncdn.com/i/teamlogos/nfl/500/cle.png", color: "#311D00", lat: 41.5061, lon: -81.6995 },
            "Dallas Cowboys": { logo: "https://a.espncdn.com/i/teamlogos/nfl/500/dal.png", color: "#003594", lat: 32.7473, lon: -97.0945 },
            "Denver Broncos": { logo: "https://a.espncdn.com/i/teamlogos/nfl/500/den.png", color: "#FB4F14", lat: 39.7439, lon: -105.0201 },
            "Detroit Lions": { logo: "https://a.espncdn.com/i/teamlogos/nfl/500/det.png", color: "#0076B6", lat: 42.3400, lon: -83.0456 },
            "Green Bay Packers": { logo: "https://a.espncdn.com/i/teamlogos/nfl/500/gb.png", color: "#203731", lat: 44.5013, lon: -88.0622 },
            "Houston Texans": { logo: "https://a.espncdn.com/i/teamlogos/nfl/500/hou.png", color: "#03202F", lat: 29.6847, lon: -95.4107 },
            "Indianapolis Colts": { logo: "https://a.espncdn.com/i/teamlogos/nfl/500/ind.png", color: "#002C5F", lat: 39.7601, lon: -86.1639 },
            "Jacksonville Jaguars": { logo: "https://a.espncdn.com/i/teamlogos/nfl/500/jax.png", color: "#006778", lat: 30.3240, lon: -81.6373 },
            "Kansas City Chiefs": { logo: "https://a.espncdn.com/i/teamlogos/nfl/500/kc.png", color: "#E31837", lat: 39.0489, lon: -94.4839 },
            "Las Vegas Raiders": { logo: "https://a.espncdn.com/i/teamlogos/nfl/500/lv.png", color: "#000000", lat: 36.0908, lon: -115.1831 },
            "Los Angeles Chargers": { logo: "https://a.espncdn.com/i/teamlogos/nfl/500/lac.png", color: "#0080C6", lat: 33.9535, lon: -118.3390 },
            "Los Angeles Rams": { logo: "https://a.espncdn.com/i/teamlogos/nfl/500/lar.png", color: "#003594", lat: 33.9535, lon: -118.3390 },
            "Miami Dolphins": { logo: "https://a.espncdn.com/i/teamlogos/nfl/500/mia.png", color: "#008E97", lat: 25.9580, lon: -80.2389 },
            "Minnesota Vikings": { logo: "https://a.espncdn.com/i/teamlogos/nfl/500/min.png", color: "#4F2683", lat: 44.9738, lon: -93.2577 },
            "New England Patriots": { logo: "https://a.espncdn.com/i/teamlogos/nfl/500/ne.png", color: "#002244", lat: 42.0909, lon: -71.2643 },
            "New Orleans Saints": { logo: "https://a.espncdn.com/i/teamlogos/nfl/500/no.png", color: "#D3BC8D", lat: 29.9511, lon: -90.0812 },
            "New York Giants": { logo: "https://a.espncdn.com/i/teamlogos/nfl/500/nyg.png", color: "#0B2265", lat: 40.8128, lon: -74.0742 },
            "New York Jets": { logo: "https://a.espncdn.com/i/teamlogos/nfl/500/nyj.png", color: "#125740", lat: 40.8128, lon: -74.0742 },
            "Philadelphia Eagles": { logo: "https://a.espncdn.com/i/teamlogos/nfl/500/phi.png", color: "#004C54", lat: 39.9008, lon: -75.1675 },
            "Pittsburgh Steelers": { logo: "https://a.espncdn.com/i/teamlogos/nfl/500/pit.png", color: "#FFB612", lat: 40.4468, lon: -80.0158 },
            "San Francisco 49ers": { logo: "https://a.espncdn.com/i/teamlogos/nfl/500/sf.png", color: "#AA0000", lat: 37.4032, lon: -121.9697 },
            "Seattle Seahawks": { logo: "https://a.espncdn.com/i/teamlogos/nfl/500/sea.png", color: "#002244", lat: 47.5952, lon: -122.3316 },
            "Tampa Bay Buccaneers": { logo: "https://a.espncdn.com/i/teamlogos/nfl/500/tb.png", color: "#D50A0A", lat: 27.9759, lon: -82.5033 },
            "Tennessee Titans": { logo: "https://a.espncdn.com/i/teamlogos/nfl/500/ten.png", color: "#0C2340", lat: 36.1665, lon: -86.7713 },
            "Washington Commanders": { logo: "https://a.espncdn.com/i/teamlogos/nfl/500/wsh.png", color: "#5A1414", lat: 38.9076, lon: -76.8645 }
        };

        // League stats cache (fetched dynamically)
        let leagueStats = {
            teams: {},
            rankings: {}
        };

        // ===== INITIALIZATION =====
        if (apiKey) {
            document.getElementById('apiKeyInput').value = apiKey;
            document.getElementById('apiSetup').style.display = 'none';
            loadAllData();
        }

        updateAccuracyDisplay();

        function saveApiKey() {
            const input = document.getElementById('apiKeyInput');
            apiKey = input.value.trim();
            if (apiKey) {
                localStorage.setItem('nfl_odds_api_key', apiKey);
                document.getElementById('apiSetup').style.display = 'none';
                loadAllData();
            } else {
                showError('Please enter a valid API key');
            }
        }

        function showError(message) {
            const errorEl = document.getElementById('error');
            errorEl.textContent = message;
            errorEl.style.display = 'block';
            setTimeout(() => errorEl.style.display = 'none', 10000);
        }

        function updateAccuracyDisplay() {
            document.getElementById('correct').textContent = accuracyStats.correct;
            document.getElementById('total').textContent = accuracyStats.total;
            const accuracy = accuracyStats.total > 0 ? ((accuracyStats.correct / accuracyStats.total) * 100).toFixed(1) : 0;
            document.getElementById('accuracy').textContent = accuracy + '%';
        }

        // ===== MAIN DATA LOADING =====
        async function loadAllData() {
            try {
                document.getElementById('loading').textContent = 'üèà Loading NFL data...';
                console.log('=== STARTING DATA LOAD ===');

                // Step 1: Fetch league-wide team stats (rushing/passing offense and defense)
                await fetchLeagueStats();

                // Step 2: Fetch upcoming games
                const games = await fetchGames();

                if (games.length === 0) {
                    document.getElementById('loading').textContent = 'No upcoming games in the next 7 days';
                    return;
                }

                // Step 3: Fetch odds
                let oddsData = [];
                try {
                    oddsData = await fetchOdds();
                } catch (e) {
                    console.warn('Could not fetch odds:', e.message);
                }

                // Step 4: Check past predictions
                await checkPredictionResults();
                updateAccuracyDisplay();

                // Step 5: Display games with predictions
                await displayGames(games, oddsData);

                document.getElementById('loading').style.display = 'none';
                console.log('=== DATA LOAD COMPLETE ===');
            } catch (error) {
                console.error('Error loading data:', error);
                showError('Failed to load data: ' + error.message);
                document.getElementById('loading').textContent = 'Error loading data. Check console.';
            }
        }

        // ===== FETCH LEAGUE STATS (NO HARDCODED DATA) =====
        async function fetchLeagueStats() {
            console.log('üìä Fetching league-wide team stats from ESPN...');

            try {
                // Fetch team stats from ESPN
                const response = await fetch('https://site.api.espn.com/apis/site/v2/sports/football/nfl/teams?limit=32');
                const data = await response.json();

                if (!data.sports?.[0]?.leagues?.[0]?.teams) {
                    throw new Error('Invalid ESPN teams response');
                }

                const teams = data.sports[0].leagues[0].teams;
                const statsArray = [];

                // Collect stats for all teams
                for (const teamObj of teams) {
                    const team = teamObj.team;
                    const teamName = team.displayName;

                    // Fetch detailed team stats
                    try {
                        const statsResp = await fetch(`https://site.api.espn.com/apis/site/v2/sports/football/nfl/teams/${team.id}/statistics`);
                        const statsData = await statsResp.json();

                        const splits = statsData.splits?.categories || [];

                        // Extract offensive stats
                        const offenseStats = splits.find(c => c.name === 'offensive') || {};
                        const rushOffYPG = parseFloat(offenseStats.stats?.find(s => s.name === 'rushingYardsPerGame')?.value || 0);
                        const passOffYPG = parseFloat(offenseStats.stats?.find(s => s.name === 'netPassingYardsPerGame')?.value || 0);

                        // Extract defensive stats
                        const defenseStats = splits.find(c => c.name === 'defensive') || {};
                        const rushDefYPG = parseFloat(defenseStats.stats?.find(s => s.name === 'rushingYardsPerGame')?.value || 0);
                        const passDefYPG = parseFloat(defenseStats.stats?.find(s => s.name === 'passingYardsPerGame')?.value || 0);

                        statsArray.push({
                            name: teamName,
                            rushOffYPG,
                            passOffYPG,
                            rushDefYPG,
                            passDefYPG
                        });

                        leagueStats.teams[teamName] = {
                            rushOffYPG,
                            passOffYPG,
                            rushDefYPG,
                            passDefYPG
                        };

                        console.log(`  ‚úì ${teamName}: Rush O=${rushOffYPG.toFixed(1)}, Pass O=${passOffYPG.toFixed(1)}`);
                    } catch (err) {
                        console.warn(`Could not fetch stats for ${teamName}:`, err.message);
                    }
                }

                // Calculate rankings
                const rushOffRanked = [...statsArray].sort((a, b) => b.rushOffYPG - a.rushOffYPG);
                const passOffRanked = [...statsArray].sort((a, b) => b.passOffYPG - a.passOffYPG);
                const rushDefRanked = [...statsArray].sort((a, b) => a.rushDefYPG - b.rushDefYPG); // Lower is better
                const passDefRanked = [...statsArray].sort((a, b) => a.passDefYPG - b.passDefYPG); // Lower is better

                // Store rankings
                statsArray.forEach(team => {
                    leagueStats.rankings[team.name] = {
                        rushOffRank: rushOffRanked.findIndex(t => t.name === team.name) + 1,
                        passOffRank: passOffRanked.findIndex(t => t.name === team.name) + 1,
                        rushDefRank: rushDefRanked.findIndex(t => t.name === team.name) + 1,
                        passDefRank: passDefRanked.findIndex(t => t.name === team.name) + 1
                    };
                });

                console.log(`‚úÖ Loaded stats for ${statsArray.length} teams`);
                console.log('Top Rush Offense:', rushOffRanked.slice(0, 3).map((t, i) => `#${i+1} ${t.name} (${t.rushOffYPG.toFixed(1)} ypg)`).join(', '));
                console.log('Top Pass Offense:', passOffRanked.slice(0, 3).map((t, i) => `#${i+1} ${t.name} (${t.passOffYPG.toFixed(1)} ypg)`).join(', '));

            } catch (error) {
                console.error('‚ùå ERROR fetching league stats:', error);
                showError('Could not load team statistics. Using basic predictions.');
            }
        }

        // ===== FETCH GAMES =====
        async function fetchGames() {
            console.log('üì• Fetching games from ESPN...');

            const games = [];
            const now = new Date();
            const sevenDaysFromNow = new Date(now.getTime() + 7 * 24 * 60 * 60 * 1000);

            const response = await fetch('https://site.api.espn.com/apis/site/v2/sports/football/nfl/scoreboard');
            const data = await response.json();

            if (data.week && data.week.number) {
                document.getElementById('weekIndicator').textContent = `Week ${data.week.number}`;
            }

            for (const event of data.events || []) {
                const gameDate = new Date(event.date);
                if (gameDate > now && gameDate < sevenDaysFromNow) {
                    games.push(event);
                }
            }

            console.log(`‚úÖ Found ${games.length} upcoming games`);
            return games;
        }

        // ===== FETCH ODDS =====
        async function fetchOdds() {
            if (!apiKey) return [];

            console.log('üí∞ Fetching odds...');
            const response = await fetch(`https://api.the-odds-api.com/v4/sports/americanfootball_nfl/odds/?apiKey=${apiKey}&regions=us&markets=spreads,totals,h2h`);

            if (!response.ok) {
                throw new Error('Failed to fetch odds');
            }

            const data = await response.json();
            console.log(`‚úÖ Fetched odds for ${data.length} games`);
            return data;
        }

        // ===== FETCH WEATHER =====
        async function fetchWeather(homeTeam, gameDate) {
            const teamInfo = TEAM_DATA[homeTeam];
            if (!teamInfo) return null;

            try {
                const date = new Date(gameDate);
                const dateStr = date.toISOString().split('T')[0];

                const url = `https://api.open-meteo.com/v1/forecast?latitude=${teamInfo.lat}&longitude=${teamInfo.lon}&hourly=temperature_2m,precipitation_probability,windspeed_10m,weathercode&temperature_unit=fahrenheit&windspeed_unit=mph&timezone=America/New_York&start_date=${dateStr}&end_date=${dateStr}`;

                const response = await fetch(url);
                const data = await response.json();

                const hour = date.getHours();
                const temp = data.hourly.temperature_2m[hour] || 70;
                const precip = data.hourly.precipitation_probability[hour] || 0;
                const wind = data.hourly.windspeed_10m[hour] || 0;
                const code = data.hourly.weathercode[hour] || 0;

                let condition = 'Clear';
                let rain = 0;
                let snow = 0;

                if (code >= 71 && code <= 77) { condition = 'Snow'; snow = 1; }
                else if (code >= 61 && code <= 67) { condition = 'Rain'; rain = 0.5; }
                else if (code >= 80 && code <= 99) { condition = 'Heavy Rain'; rain = 1; }
                else if (code >= 45 && code <= 48) condition = 'Fog';

                return {
                    temp: Math.round(temp),
                    precipitation: precip,
                    windSpeed: Math.round(wind),
                    condition,
                    rain,
                    snow
                };
            } catch (error) {
                console.warn('Weather fetch failed:', error.message);
                return null;
            }
        }

        // ===== GENERATE PREDICTION WITH MATCHUP DIFFERENTIAL =====
        function generatePrediction(game, odds, weather) {
            const competition = game.competitions[0];
            const homeComp = competition.competitors.find(c => c.homeAway === 'home');
            const awayComp = competition.competitors.find(c => c.homeAway === 'away');

            const homeTeam = homeComp.team.displayName;
            const awayTeam = awayComp.team.displayName;

            const homeRecord = homeComp.records?.[0]?.summary || '0-0';
            const awayRecord = awayComp.records?.[0]?.summary || '0-0';

            // Get team rankings
            const homeRankings = leagueStats.rankings[homeTeam] || {};
            const awayRankings = leagueStats.rankings[awayTeam] || {};
            const homeStats = leagueStats.teams[homeTeam] || {};
            const awayStats = leagueStats.teams[awayTeam] || {};

            let prediction = {
                homeTeam,
                awayTeam,
                homeRecord,
                awayRecord,
                spread: 'N/A',
                total: 'N/A',
                weather: weather,
                rationale: [],
                edges: []
            };

            // Parse odds
            if (odds) {
                const spreadsMarket = odds.bookmakers?.[0]?.markets?.find(m => m.key === 'spreads');
                const totalsMarket = odds.bookmakers?.[0]?.markets?.find(m => m.key === 'totals');

                if (spreadsMarket) {
                    const homeSpread = spreadsMarket.outcomes.find(o => o.name === homeTeam);
                    prediction.spread = homeSpread?.point || 'N/A';
                }
                if (totalsMarket) {
                    prediction.total = totalsMarket.outcomes[0]?.point || 'N/A';
                }
            }

            // Base scores from records
            const [homeWins, homeLosses] = homeRecord.split('-').map(n => parseInt(n) || 0);
            const [awayWins, awayLosses] = awayRecord.split('-').map(n => parseInt(n) || 0);
            const homeWinPct = (homeWins + homeLosses) > 0 ? homeWins / (homeWins + homeLosses) : 0.5;
            const awayWinPct = (awayWins + awayLosses) > 0 ? awayWins / (awayWins + awayLosses) : 0.5;

            let baseHomeScore = 21;
            let baseAwayScore = 21;

            // Use Vegas total if available
            if (prediction.spread !== 'N/A' && prediction.total !== 'N/A') {
                const spread = parseFloat(prediction.spread);
                const total = parseFloat(prediction.total);
                baseHomeScore = (total - spread) / 2;
                baseAwayScore = (total + spread) / 2;
            }

            // Home field advantage
            baseHomeScore += 2.5;

            // Win percentage adjustments
            baseHomeScore += (homeWinPct - 0.5) * 4;
            baseAwayScore += (awayWinPct - 0.5) * 4;

            // ===== MATCHUP DIFFERENTIAL ANALYSIS =====
            let matchupAdvantage = 0;

            // Weather context weights
            let rushWeight = 1;
            let passWeight = 1;

            if (weather) {
                if (weather.snow) {
                    rushWeight = 3;
                    passWeight = 0.5;
                    prediction.edges.push(`${weather.condition} conditions - rushing game heavily favored`);
                } else if (weather.rain > 0.5) {
                    rushWeight = 2;
                    passWeight = 0.7;
                    prediction.edges.push(`${weather.condition} expected - running game favored`);
                }

                if (weather.windSpeed > 20) {
                    passWeight *= 0.3;
                    prediction.edges.push(`High winds (${weather.windSpeed}mph) - passing severely limited`);
                }
            }

            // Calculate rushing matchup advantage (non-linear scaling)
            if (homeRankings.rushOffRank && awayRankings.rushDefRank) {
                const rushGap = awayRankings.rushDefRank - homeRankings.rushOffRank;
                const rushAdvantage = Math.min(7, (rushGap * rushGap) / 100) * rushWeight;
                matchupAdvantage += rushAdvantage;

                if (Math.abs(rushGap) > 15) {
                    const favored = rushGap > 0 ? homeTeam : awayTeam;
                    prediction.edges.push(`${favored} #${rushGap > 0 ? homeRankings.rushOffRank : awayRankings.rushOffRank} rush offense vs #${rushGap > 0 ? awayRankings.rushDefRank : homeRankings.rushDefRank} rush defense`);
                }
            }

            // Calculate passing matchup advantage
            if (homeRankings.passOffRank && awayRankings.passDefRank) {
                const passGap = awayRankings.passDefRank - homeRankings.passOffRank;
                const passAdvantage = Math.min(7, (passGap * passGap) / 100) * passWeight;
                matchupAdvantage += passAdvantage;

                if (Math.abs(passGap) > 15) {
                    const favored = passGap > 0 ? homeTeam : awayTeam;
                    prediction.edges.push(`${favored} #${passGap > 0 ? homeRankings.passOffRank : awayRankings.passOffRank} pass offense vs #${passGap > 0 ? awayRankings.passDefRank : homeRankings.passDefRank} pass defense`);
                }
            }

            // Reverse matchup (away offense vs home defense)
            if (awayRankings.rushOffRank && homeRankings.rushDefRank) {
                const rushGap = homeRankings.rushDefRank - awayRankings.rushOffRank;
                matchupAdvantage -= Math.min(7, (rushGap * rushGap) / 100) * rushWeight;
            }

            if (awayRankings.passOffRank && homeRankings.passDefRank) {
                const passGap = homeRankings.passDefRank - awayRankings.passOffRank;
                matchupAdvantage -= Math.min(7, (passGap * passGap) / 100) * passWeight;
            }

            // Apply matchup advantage (capped at ¬±10 points)
            matchupAdvantage = Math.max(-10, Math.min(10, matchupAdvantage));
            baseHomeScore += matchupAdvantage;

            // Finalize scores
            prediction.homeScore = Math.max(10, Math.round(baseHomeScore));
            prediction.awayScore = Math.max(10, Math.round(baseAwayScore));

            if (prediction.homeScore === prediction.awayScore) {
                prediction.homeScore += 1;
            }

            prediction.winner = prediction.homeScore > prediction.awayScore ? homeTeam : awayTeam;
            const margin = Math.abs(prediction.homeScore - prediction.awayScore);

            // Build rationale
            prediction.rationale.push(`${prediction.winner} by ${margin} points`);

            if (prediction.spread !== 'N/A') {
                const spreadFav = parseFloat(prediction.spread) < 0 ? homeTeam : awayTeam;
                prediction.rationale.push(`Vegas favors ${spreadFav} (${Math.abs(parseFloat(prediction.spread))} pts)`);
            }

            if (Math.abs(matchupAdvantage) > 3) {
                prediction.rationale.push(`Significant matchup advantage (${matchupAdvantage > 0 ? homeTeam : awayTeam})`);
            }

            const winnerWinPct = prediction.winner === homeTeam ? homeWinPct : awayWinPct;
            if (winnerWinPct > 0.6) {
                prediction.rationale.push(`Strong ${(winnerWinPct * 100).toFixed(0)}% win rate`);
            }

            // Confidence
            let confidenceScore = margin;
            if (Math.abs(matchupAdvantage) > 5) confidenceScore += 4;
            if (prediction.edges.length >= 2) confidenceScore += 3;
            if (winnerWinPct > 0.7) confidenceScore += 3;

            if (confidenceScore >= 12) prediction.confidence = 'High';
            else if (confidenceScore >= 6) prediction.confidence = 'Medium';
            else prediction.confidence = 'Low';

            // Spread bet
            if (prediction.spread !== 'N/A') {
                const actualMargin = prediction.homeScore - prediction.awayScore;
                prediction.beatsSpread = actualMargin > parseFloat(prediction.spread) ? 'Yes' : 'No';
            } else {
                prediction.beatsSpread = 'N/A';
            }

            return prediction;
        }

        // ===== DISPLAY GAMES =====
        async function displayGames(games, oddsData) {
            const gamesContainer = document.getElementById('games');
            const picksList = document.getElementById('picks-list');
            const picksSummary = document.getElementById('picksummary');

            gamesContainer.innerHTML = '';
            picksList.innerHTML = '';

            if (games.length === 0) {
                gamesContainer.innerHTML = '<div style="text-align: center; padding: 3rem;">No upcoming games</div>';
                return;
            }

            const gamesWithPredictions = [];

            for (const game of games) {
                const competition = game.competitions[0];
                const homeComp = competition.competitors.find(c => c.homeAway === 'home');
                const homeTeam = homeComp.team.displayName;

                const gameOdds = oddsData.find(o =>
                    o.home_team === homeTeam ||
                    (o.home_team.includes(homeTeam.split(' ').pop()) && o.commence_time &&
                     Math.abs(new Date(o.commence_time) - new Date(game.date)) < 3600000)
                );

                const weather = await fetchWeather(homeTeam, game.date);
                const prediction = generatePrediction(game, gameOdds, weather);

                const gameId = game.id;
                savePrediction(gameId, game.date, prediction);

                gamesWithPredictions.push({ game, prediction, gameId });
            }

            const confidenceOrder = { 'High': 0, 'Medium': 1, 'Low': 2 };
            gamesWithPredictions.sort((a, b) => {
                const dateA = new Date(a.game.date);
                const dateB = new Date(b.game.date);
                if (dateA.toDateString() !== dateB.toDateString()) {
                    return dateA - dateB;
                }
                return confidenceOrder[a.prediction.confidence] - confidenceOrder[b.prediction.confidence];
            });

            gamesWithPredictions.forEach(({ prediction, gameId }) => {
                const teamColor = TEAM_DATA[prediction.winner]?.color || '#e74c3c';
                const loser = prediction.winner === prediction.homeTeam ? prediction.awayTeam : prediction.homeTeam;

                picksList.innerHTML += `
                    <div onclick="document.getElementById('${gameId}').scrollIntoView({behavior: 'smooth', block: 'center'})"
                         style="background: rgba(255,255,255,0.05); padding: 0.75rem; border-radius: 0.5rem; cursor: pointer; border-left: 4px solid ${teamColor}; transition: all 0.2s;"
                         onmouseover="this.style.background='rgba(255,255,255,0.1)'"
                         onmouseout="this.style.background='rgba(255,255,255,0.05)'">
                        <div style="font-weight: bold; font-size: 1.1rem;">${prediction.winner}</div>
                        <div style="font-size: 0.85rem; opacity: 0.9;">over ${loser}</div>
                        <div style="font-size: 0.75rem; opacity: 0.8; margin-top: 0.25rem;">
                            ${prediction.homeScore}-${prediction.awayScore} ‚Ä¢ ${prediction.confidence}
                        </div>
                    </div>
                `;
            });
            picksSummary.style.display = 'block';

            gamesWithPredictions.forEach(({ game, prediction, gameId }) => {
                gamesContainer.innerHTML += createGameCard(game, prediction, gameId);
            });
        }

        function createGameCard(game, prediction, gameId) {
            const teamColor = TEAM_DATA[prediction.homeTeam]?.color || '#e74c3c';
            const homeLogo = TEAM_DATA[prediction.homeTeam]?.logo;
            const awayLogo = TEAM_DATA[prediction.awayTeam]?.logo;

            const gameDate = new Date(game.date);
            const gameTime = gameDate.toLocaleDateString('en-US', {
                weekday: 'short',
                month: 'short',
                day: 'numeric',
                hour: 'numeric',
                minute: '2-digit'
            });

            const confidenceClass = `confidence-${prediction.confidence.toLowerCase()}`;

            let weatherHTML = '';
            if (prediction.weather) {
                const w = prediction.weather;
                let weatherIcon = '‚òÄÔ∏è';
                if (w.condition === 'Snow') weatherIcon = '‚ùÑÔ∏è';
                else if (w.condition.includes('Rain')) weatherIcon = 'üåßÔ∏è';
                else if (w.condition === 'Fog') weatherIcon = 'üå´Ô∏è';

                weatherHTML = `<div class="badge" style="background: rgba(255,255,255,0.2);">${weatherIcon} ${w.temp}¬∞F ${w.condition}${w.windSpeed > 15 ? ` ‚Ä¢ ${w.windSpeed}mph` : ''}</div>`;
            }

            let rationaleHTML = '';
            if (prediction.rationale.length > 0) {
                rationaleHTML = '<div class="rationale">';
                prediction.rationale.forEach(reason => {
                    rationaleHTML += `<div class="rationale-item">‚úì ${reason}</div>`;
                });
                rationaleHTML += '</div>';
            }

            let edgesHTML = '';
            if (prediction.edges.length > 0) {
                edgesHTML = '<div class="prediction-section"><div class="prediction-title">‚ö° Key Matchup Edges</div>';
                prediction.edges.forEach(edge => {
                    edgesHTML += `<div class="matchup-edge"><div class="edge-item">üî• ${edge}</div></div>`;
                });
                edgesHTML += '</div>';
            }

            return `
                <div id="${gameId}" class="game-card" style="background: linear-gradient(135deg, ${teamColor}22 0%, ${teamColor}44 100%); border: 2px solid ${teamColor}88;">
                    <div class="game-header" style="background-color: ${teamColor}ee;">
                        <div class="game-meta">
                            <div class="badge">üìÖ ${gameTime}</div>
                            ${weatherHTML}
                            <div class="badge ${confidenceClass}">${prediction.confidence.toUpperCase()}</div>
                        </div>
                        <div class="teams">
                            <div class="team">
                                ${awayLogo ? `<img src="${awayLogo}" alt="${prediction.awayTeam}" class="team-logo">` : ''}
                                <div>
                                    <div class="team-name">${prediction.awayTeam}</div>
                                    <div class="team-record">${prediction.awayRecord}</div>
                                </div>
                            </div>
                            <div class="vs">@</div>
                            <div class="team">
                                <div style="text-align: right;">
                                    <div class="team-name">${prediction.homeTeam}</div>
                                    <div class="team-record">${prediction.homeRecord}</div>
                                </div>
                                ${homeLogo ? `<img src="${homeLogo}" alt="${prediction.homeTeam}" class="team-logo">` : ''}
                            </div>
                        </div>
                    </div>
                    <div class="game-body">
                        <div class="winner-section">
                            <div class="winner-label">üéØ PREDICTED WINNER</div>
                            <div class="winner-name">${prediction.winner}</div>
                            <div class="confidence">Confidence: ${prediction.confidence}</div>
                            ${rationaleHTML}
                        </div>

                        ${edgesHTML}

                        <div class="prediction-section">
                            <div class="prediction-title">üìä Score Prediction</div>
                            <div class="prediction-grid">
                                <div class="pred-stat">
                                    <div class="pred-label">${prediction.homeTeam}</div>
                                    <div class="pred-value">${prediction.homeScore}</div>
                                </div>
                                <div class="pred-stat">
                                    <div class="pred-label">${prediction.awayTeam}</div>
                                    <div class="pred-value">${prediction.awayScore}</div>
                                </div>
                            </div>
                        </div>

                        <div class="prediction-section">
                            <div class="prediction-title">üí∞ Betting Lines</div>
                            <div class="stats-breakdown">
                                <div class="stat-row">
                                    <span>Spread:</span>
                                    <strong>${prediction.homeTeam} ${prediction.spread}</strong>
                                </div>
                                <div class="stat-row">
                                    <span>Over/Under:</span>
                                    <strong>${prediction.total}</strong>
                                </div>
                                <div class="stat-row">
                                    <span>Beats Spread:</span>
                                    <strong>${prediction.beatsSpread}</strong>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function savePrediction(gameId, gameDate, prediction) {
            const gameTime = new Date(gameDate);
            const now = new Date();

            if (now < gameTime) {
                predictions[gameId] = {
                    date: gameDate,
                    prediction: {
                        winner: prediction.winner,
                        homeTeam: prediction.homeTeam,
                        awayTeam: prediction.awayTeam,
                        homeScore: prediction.homeScore,
                        awayScore: prediction.awayScore
                    }
                };
                localStorage.setItem('nfl_predictions', JSON.stringify(predictions));
            }
        }

        async function checkPredictionResults() {
            const now = new Date();
            const fourHoursAgo = new Date(now.getTime() - 4 * 60 * 60 * 1000);

            for (const gameId in predictions) {
                const pred = predictions[gameId];
                const gameDate = new Date(pred.date);

                if (gameDate < fourHoursAgo && !pred.checked) {
                    try {
                        const response = await fetch(`https://site.api.espn.com/apis/site/v2/sports/football/nfl/summary?event=${gameId}`);
                        const data = await response.json();

                        const competition = data.boxscore?.teams;
                        if (competition && competition.length === 2) {
                            const homeTeam = competition.find(t => t.homeAway === 'home');
                            const awayTeam = competition.find(t => t.homeAway === 'away');

                            const homeScore = parseInt(homeTeam.statistics.find(s => s.name === 'points')?.displayValue || 0);
                            const awayScore = parseInt(awayTeam.statistics.find(s => s.name === 'points')?.displayValue || 0);

                            const actualWinner = homeScore > awayScore ? homeTeam.team.displayName : awayTeam.team.displayName;
                            const predictedWinner = pred.prediction.winner;

                            if (actualWinner === predictedWinner) {
                                accuracyStats.correct++;
                            }
                            accuracyStats.total++;

                            pred.checked = true;
                            predictions[gameId] = pred;
                        }
                    } catch (e) {
                        console.warn(`Could not check result for game ${gameId}`);
                    }
                }
            }

            localStorage.setItem('nfl_predictions', JSON.stringify(predictions));
            localStorage.setItem('nfl_accuracy', JSON.stringify(accuracyStats));
        }
    </script>
</body>
</html>
